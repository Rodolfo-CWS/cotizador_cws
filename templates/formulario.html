<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cotizador CWS - Nuevo Formulario</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --success: #10b981;
            --danger: #dc2626;
            --warning: #f59e0b;
            --gray-50: #f8f9fa;
            --gray-100: #f1f3f4;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --gray-400: #ced4da;
            --gray-500: #adb5bd;
            --gray-600: #6c757d;
            --gray-700: #495057;
            --gray-800: #343a40;
            --gray-900: #212529;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--gray-50) !important;
            color: var(--gray-800);
        }
        
        .btn-loading { opacity: 0.6; cursor: wait !important; }
        .item-block { transition: all 0.2s ease; }
        .item-block:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        details[open] summary ~ * { animation: slideDown 0.3s ease; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Override Tailwind colors with minimalist grayscale */
        .bg-gradient-to-r { background: var(--gray-800) !important; }
        .text-white { color: white !important; }
        .text-blue-200 { color: var(--gray-400) !important; }
        .text-blue-700 { color: var(--gray-700) !important; }
        .bg-white { background: white !important; }
        .shadow-lg { box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24) !important; }
        .rounded-lg { border-radius: 8px !important; }
        .border-gray-300 { border-color: var(--gray-300) !important; }
        .focus\:ring-blue-500:focus { box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1) !important; }
        .focus\:border-blue-500:focus { border-color: var(--primary) !important; }
        .text-gray-700 { color: var(--gray-700) !important; }
        
        /* Icon buttons styles */
        .icon-btn {
            width: 40px;
            height: 40px;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            background: white;
            color: var(--gray-600);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .icon-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .icon-btn.primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .icon-btn.success {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }
        
        .icon-btn.danger {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        /* Modal de Descripción de Revisión */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary) 0%, #6366f1 100%);
            color: white;
            padding: 24px;
            border-radius: 12px 12px 0 0;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 16px 24px;
            background: var(--gray-50);
            border-radius: 0 0 12px 12px;
            display: flex;
            justify-content: flex-end;
        }

        .form-disabled {
            opacity: 0.5;
            pointer-events: none;
            user-select: none;
        }

        #descripcion-revision-input {
            min-height: 120px;
            resize: vertical;
        }
    </style>
</head>
<body class="min-h-screen py-6">

<!-- MODAL DE DESCRIPCIÓN DE REVISIÓN -->
<div id="modal-revision" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="text-2xl font-bold mb-2">Nueva Revisión</h2>
            <p class="text-sm opacity-90">Revisión <span id="numero-revision-modal"></span></p>
        </div>

        <div class="modal-body">
            <div class="mb-4">
                <p class="text-gray-700 mb-4">
                    <strong>¿Cuál es el cambio principal de esta revisión?</strong>
                </p>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Descripción del cambio:
                    <span class="text-red-500">*</span>
                </label>
                <textarea
                    id="descripcion-revision-input"
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    placeholder="Ejemplo: Actualización de precios, cambio de materiales, ajuste de cantidades, etc."
                    rows="4"
                ></textarea>
                <p class="text-xs text-gray-500 mt-1">
                    Mínimo 10 caracteres. Caracteres actuales: <span id="contador-caracteres">0</span>
                </p>
            </div>

            <div id="error-descripcion" class="text-red-600 text-sm mb-2" style="display: none;">
                Por favor, ingrese una descripción de al menos 10 caracteres.
            </div>
        </div>

        <div class="modal-footer">
            <button
                type="button"
                id="btn-confirmar-revision"
                class="px-6 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                disabled
            >
                Continuar con la Cotización
            </button>
        </div>
    </div>
</div>

<!-- MODAL DE BLOQUEO DE REVISIÓN ANTIGUA -->
<div id="modal-revision-bloqueada" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header" style="background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);">
            <h2 class="text-2xl font-bold mb-2">Revisión Antigua Detectada</h2>
            <p class="text-sm opacity-90">No se puede crear nueva revisión desde esta versión</p>
        </div>

        <div class="modal-body">
            <div class="mb-4">
                <div class="bg-red-50 border-l-4 border-red-500 p-3">
                    <p class="text-gray-800 font-semibold text-sm">
                        Esta cotización tiene versiones más recientes disponibles.
                    </p>
                    <p class="text-gray-600 text-xs mt-1">
                        Las nuevas revisiones deben crearse desde la versión más reciente.
                    </p>
                </div>
            </div>

            <!-- Historial de Revisiones -->
            <div class="mb-4">
                <p class="text-sm font-semibold text-gray-700 mb-2">Historial de Revisiones:</p>
                <div id="historial-revisiones-lista" class="space-y-2 max-h-96 overflow-y-auto">
                    <!-- Se llenará dinámicamente con JavaScript -->
                </div>
            </div>

            <div class="bg-blue-50 border-l-4 border-blue-500 p-3">
                <p class="text-xs text-blue-800">
                    <strong>Tip:</strong> Haz click en "Ir a la Última Revisión" para crear una nueva versión.
                </p>
            </div>
        </div>

        <div class="modal-footer">
            <button
                type="button"
                id="btn-ir-ultima-revision"
                class="px-6 py-3 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition-colors mr-3"
            >
                Ir a la Última Revisión
            </button>
            <button
                type="button"
                id="btn-volver-busqueda"
                class="px-6 py-3 bg-gray-600 text-white rounded-lg font-medium hover:bg-gray-700 transition-colors"
            >
                Volver a Búsqueda
            </button>
        </div>
    </div>
</div>

<!-- ENCABEZADO -->
<header class="bg-gradient-to-r from-blue-700 to-blue-800 text-white shadow-lg mb-6">
    <div class="container mx-auto px-4 py-6">
        <div class="flex justify-between items-center">
            <div class="flex items-center gap-4">
                <img src="/static/logo.png" alt="CWS Company" style="max-height: 50px; max-width: 120px; object-fit: contain;">
                <div>
                    <h1 class="text-3xl font-bold">Cotizador CWS</h1>
                    <p class="text-blue-200 mt-1">Sistema de Cotizaciones - Nuevo Formulario</p>
                </div>
            </div>
            <div class="text-right">
                <p class="text-sm"><span id="fecha-actual"></span></p>
                <p class="text-xs text-blue-200">Versión 2.0</p>
            </div>
        </div>
    </div>
</header>

<div class="container mx-auto px-4">
    <!-- FORMULARIO PRINCIPAL -->
    <form id="cotizacion-form" class="space-y-6">
        
        <!-- DATOS GENERALES -->
        <section class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-bold text-blue-700 mb-4 flex items-center">
                Datos Generales
            </h2>
            
            <div id="datos-generales-form">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Vendedor:</label>
                        <input type="text" name="vendedor" required
                               value="{{ vendedor_sesion }}"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Proyecto:</label>
                        <input type="text" name="proyecto" required 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Cliente:</label>
                        <input type="text" name="cliente" required 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Atención A:</label>
                        <input type="text" name="atencionA" required 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Contacto:</label>
                        <input type="text" name="contacto" required 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">No. Cotización:</label>
                        <input type="text" name="numeroCotizacion" id="numeroCotizacion" disabled 
                               class="w-full p-3 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed text-gray-600"
                               placeholder="Se generará automáticamente" tabindex="-1">
                        <input type="hidden" name="numeroCotizacionHidden" id="numeroCotizacionHidden">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Revisión:</label>
                        <input type="number" name="revision" id="revision" min="1" value="1" onchange="manejarRevision()"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div id="actualizacion-container" style="display: none;" class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Justificación de Actualización: 
                            <span class="text-red-500 font-bold">*</span>
                            <span class="text-xs text-gray-500">(mínimo 10 caracteres)</span>
                        </label>
                        <textarea name="actualizacionRevision" rows="3" 
                                  class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                  placeholder="Describa detalladamente los cambios realizados en esta revisión (mínimo 10 caracteres)..."
                                  minlength="10"></textarea>
                    </div>
                </div>
            </div>
        </section>
        <!-- ITEMS DINÁMICOS -->
        <section class="bg-white rounded-lg shadow-lg p-6">
            <div class="mb-4">
                <h2 class="text-2xl font-bold text-blue-700 flex items-center">
                    Items de Cotización
                </h2>
            </div>
            
            <div id="items-container" class="space-y-4">
                <!-- Los items se agregan dinámicamente aquí -->
            </div>
            
            <div class="mt-6 text-center">
                <button type="button" onclick="agregarItem()" 
                        class="icon-btn success flex items-center gap-2 px-4 py-2 w-auto h-auto rounded-lg">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                    </svg>
                    Agregar Item
                </button>
            </div>
        </section>

        <!-- TÉRMINOS Y CONDICIONES -->
        <section class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-bold text-blue-700 mb-4 flex items-center">
                Términos y Condiciones
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Moneda:</label>
                    <select name="moneda" id="moneda" required onchange="toggleTipoCambio()" 
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Seleccione moneda</option>
                        <option value="MXN">MXN - Peso Mexicano</option>
                        <option value="USD">USD - Dólar Americano</option>
                    </select>
                </div>
                
                <div id="tipo-cambio-container" style="display: none;">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Cambio:</label>
                    <input type="number" name="tipoCambio" id="tipo-cambio" step="0.01" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tiempo de Entrega:</label>
                    <input type="text" name="tiempoEntrega" required 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           placeholder="Ej. 15 días hábiles">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Entregar En:</label>
                    <input type="text" name="entregaEn" required 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           placeholder="Ubicación de entrega">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Términos de Pago:</label>
                    <input type="text" name="terminos" required 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           placeholder="Ej. 50% anticipo, 50% contra entrega">
                </div>
            </div>
            
            <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Comentarios Adicionales:</label>
                <textarea name="comentarios" rows="3" 
                          class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                          placeholder="Comentarios o notas adicionales..."></textarea>
            </div>
        </section>

        <!-- RESUMEN FINANCIERO DESGLOSADO -->
        <section class="bg-white rounded-lg shadow-lg p-6 border border-gray-300">
            <h2 class="text-2xl font-bold text-gray-700 mb-4 flex items-center">
                Resumen Financiero
            </h2>
            
            <!-- Desglose por Items -->
            <div id="resumen-items" class="mb-6">
                <!-- Se genera dinámicamente -->
            </div>
            
            <!-- Totales Generales -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 pt-4 border-t border-gray-300">
                <div class="bg-gray-50 p-4 rounded-lg border">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Subtotal Items:</h3>
                    <p id="subtotal-items" class="text-2xl font-bold text-gray-800">$0.00</p>
                </div>
                
                <div class="bg-gray-50 p-4 rounded-lg border">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">IVA (16%):</h3>
                    <p id="iva-total" class="text-2xl font-bold text-gray-800">$0.00</p>
                </div>
                
                <div class="bg-gray-100 p-4 rounded-lg border-2 border-gray-400">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">GRAN TOTAL:</h3>
                    <p id="gran-total" class="text-3xl font-bold text-gray-900">$0.00</p>
                </div>
            </div>
        </section>

        <!-- BOTONES DE ACCIÓN -->
        <section class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <button type="button" id="btn-guardar" onclick="guardarCotizacion()" 
                        class="icon-btn primary flex items-center gap-2 px-6 py-3 w-auto h-auto rounded-lg font-medium transition-all duration-200">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.11 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/>
                    </svg>
                    Guardar
                </button>
                
                <button type="button" id="btn-generar" onclick="intentarGenerarCotizacion()" disabled
                        class="icon-btn flex items-center gap-2 px-6 py-3 w-auto h-auto rounded-lg font-medium opacity-50 cursor-not-allowed">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                    </svg>
                    PDF
                </button>
                
                <button type="button" onclick="location.reload()" 
                        class="icon-btn flex items-center gap-2 px-6 py-3 w-auto h-auto rounded-lg font-medium">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z"/>
                    </svg>
                    Limpiar
                </button>
                
                <a href="/" 
                   class="icon-btn primary flex items-center gap-2 px-6 py-3 w-auto h-auto rounded-lg font-medium text-center no-underline">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z"/>
                    </svg>
                    Home
                </a>
            </div>
        </section>
    </form>
</div>
<script>
// Lista de materiales cargada desde el servidor
const LISTA_MATERIALES = {{ materiales | tojson }};

// Datos precargados (para nueva revisión)
const DATOS_PRECARGADOS = {{ datos_precargados | tojson if datos_precargados else 'null' }};

// Información de bloqueo de revisión (si intenta crear revisión desde versión antigua)
const INFO_BLOQUEO_REVISION = {{ info_bloqueo_revision | tojson if info_bloqueo_revision else 'null' }};

// Función para generar opciones de materiales
function generarOpcionesMateriales() {
    let opciones = '<option value="" data-peso="0" data-uom="">Seleccione Material</option>';
    opciones += '<option value="COTIZAR_POR_PESO" data-peso="0" data-uom="KG">Cotizar por peso</option>';
    LISTA_MATERIALES.forEach(material => {
        opciones += `<option value="${material.descripcion}" data-peso="${material.peso}" data-uom="${material.uom}">${material.descripcion}</option>`;
    });
    return opciones;
}

let cotizacionGuardada = false;
let estadoInicialFormulario = null; // Para detectar cambios en revisiones

// ============================================
// SISTEMA DE AUTO-GUARDADO DE DRAFTS
// ============================================

let draftActualId = null;
let autoGuardadoTimer = null;
let formModificado = false;
let ultimoGuardadoTimestamp = null;

function inicializarSistemaAutoGuardado() {
    console.log('[DRAFT] Inicializando sistema de auto-guardado...');

    // Detectar cambios en el formulario
    const form = document.getElementById('cotizacion-form');
    if (form) {
        form.addEventListener('input', function() {
            formModificado = true;
        });

        form.addEventListener('change', function() {
            formModificado = true;
        });
    }

    // Iniciar auto-guardado cada 30 segundos
    autoGuardadoTimer = setInterval(autoGuardarDraft, 30000);

    // Guardar antes de cerrar/recargar página
    window.addEventListener('beforeunload', function(e) {
        if (formModificado) {
            autoGuardarDraftSincrono();
        }
    });

    console.log('[DRAFT] Sistema de auto-guardado iniciado (cada 30 segundos)');
}

async function autoGuardarDraft() {
    // Solo guardar si hay cambios y hay datos en el formulario
    if (!formModificado) {
        console.log('[DRAFT] Sin cambios, omitiendo auto-guardado');
        return;
    }

    // Verificar que haya al menos cliente o vendedor antes de guardar
    const vendedor = document.querySelector('[name="vendedor"]')?.value?.trim();
    const cliente = document.querySelector('[name="cliente"]')?.value?.trim();

    if (!vendedor && !cliente) {
        console.log('[DRAFT] Formulario vacío, omitiendo auto-guardado');
        return;
    }

    try {
        console.log('[DRAFT] Ejecutando auto-guardado...');

        // Recopilar datos del formulario
        const datosGenerales = recopilarDatosGenerales();
        const items = recopilarItems();
        const condiciones = recopilarCondiciones();

        const datosDraft = {
            vendedor: vendedor || 'UNKNOWN',
            datos: {
                datosGenerales: datosGenerales,
                items: items,
                condiciones: condiciones
            }
        };

        // Si ya existe un draft_id, incluirlo para actualizar
        if (draftActualId) {
            datosDraft.draft_id = draftActualId;
        }

        const respuesta = await fetch('/api/draft/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(datosDraft)
        });

        if (respuesta.ok) {
            const resultado = await respuesta.json();

            if (resultado.success) {
                draftActualId = resultado.draft_id;
                ultimoGuardadoTimestamp = resultado.timestamp;
                formModificado = false;

                console.log('[DRAFT] Auto-guardado exitoso:', resultado.draft_id);
                mostrarNotificacionGuardado();
            } else {
                console.error('[DRAFT] Error auto-guardando:', resultado.error);
            }
        } else {
            console.error('[DRAFT] Error HTTP auto-guardando:', respuesta.status);
        }

    } catch (error) {
        console.error('[DRAFT] Excepción auto-guardando:', error);
    }
}

function autoGuardarDraftSincrono() {
    // Versión síncrona para beforeunload (no espera respuesta)
    const vendedor = document.querySelector('[name="vendedor"]')?.value?.trim();

    if (!vendedor) return;

    const datosGenerales = recopilarDatosGenerales();
    const items = recopilarItems();
    const condiciones = recopilarCondiciones();

    const datosDraft = {
        vendedor: vendedor,
        datos: {
            datosGenerales: datosGenerales,
            items: items,
            condiciones: condiciones
        }
    };

    if (draftActualId) {
        datosDraft.draft_id = draftActualId;
    }

    // Usar sendBeacon para garantizar que se envíe antes de cerrar
    const blob = new Blob([JSON.stringify(datosDraft)], { type: 'application/json' });
    navigator.sendBeacon('/api/draft/save', blob);
}

function mostrarNotificacionGuardado() {
    // Crear notificación temporal de guardado exitoso
    const notif = document.createElement('div');
    notif.textContent = 'Borrador guardado';
    notif.className = 'fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded shadow-lg text-sm z-50';
    notif.style.animation = 'fadeIn 0.3s, fadeOut 0.3s 2s';

    document.body.appendChild(notif);

    setTimeout(() => {
        notif.remove();
    }, 2500);
}

function recopilarDatosGenerales() {
    const campos = [
        'fecha', 'vendedor', 'cliente', 'telefono', 'correo',
        'proyecto', 'numeroProyecto', 'emitidaPor', 'numeroCotizacion'
    ];

    const datos = {};
    campos.forEach(campo => {
        const elemento = document.querySelector(`[name="${campo}"]`);
        if (elemento) {
            datos[campo] = elemento.value?.trim() || '';
        }
    });

    return datos;
}

function recopilarItems() {
    const itemsRows = document.querySelectorAll('#items-body tr');
    const items = [];

    itemsRows.forEach(row => {
        const item = {
            descripcion: row.querySelector('[name="descripcion"]')?.value || '',
            unidad: row.querySelector('[name="unidad"]')?.value || '',
            cantidad: parseFloat(row.querySelector('[name="cantidad"]')?.value) || 0,
            precioUnitario: parseFloat(row.querySelector('[name="precioUnitario"]')?.value) || 0
        };

        // Solo agregar items con al menos descripción
        if (item.descripcion) {
            items.push(item);
        }
    });

    return items;
}

function recopilarCondiciones() {
    const moneda = document.querySelector('[name="moneda"]')?.value || 'MXN';

    return {
        tiempoEntrega: document.querySelector('[name="tiempoEntrega"]')?.value || '',
        condicionesPago: document.querySelector('[name="condicionesPago"]')?.value || '',
        comentariosAdicionales: document.querySelector('[name="comentariosAdicionales"]')?.value || '',
        moneda: moneda,
        tipoCambio: moneda === 'USD' ? (document.querySelector('[name="tipoCambio"]')?.value || '') : null
    };
}

async function cargarDraftSeleccionado(draftId) {
    try {
        console.log('[DRAFT] Cargando draft:', draftId);

        const respuesta = await fetch(`/api/draft/load/${draftId}`);

        if (!respuesta.ok) {
            throw new Error(`Error HTTP ${respuesta.status}`);
        }

        const resultado = await respuesta.json();

        if (resultado.success && resultado.draft) {
            const draft = resultado.draft;

            // Establecer draft actual
            draftActualId = draft.id;

            // Cargar datos en el formulario
            const datos = draft.datos || {};
            const datosGenerales = datos.datosGenerales || {};
            const items = datos.items || [];
            const condiciones = datos.condiciones || {};

            console.log('[DRAFT] Datos a cargar:', { datosGenerales, items: items.length, condiciones });

            // Llenar datos generales con verificación
            let camposLlenados = 0;
            Object.keys(datosGenerales).forEach(key => {
                const elemento = document.querySelector(`[name="${key}"]`);
                if (elemento) {
                    if (datosGenerales[key]) {
                        elemento.value = datosGenerales[key];
                        // Disparar evento para que se actualice visualmente
                        elemento.dispatchEvent(new Event('input', { bubbles: true }));
                        elemento.dispatchEvent(new Event('change', { bubbles: true }));
                        camposLlenados++;
                        console.log(`[DRAFT] Campo ${key} llenado:`, datosGenerales[key]);
                    }
                } else {
                    console.warn(`[DRAFT] Campo ${key} no encontrado en formulario`);
                }
            });
            console.log(`[DRAFT] ${camposLlenados} campos generales llenados`);

            // Limpiar y cargar items
            const itemsBody = document.getElementById('items-body');
            if (itemsBody && items.length > 0) {
                console.log('[DRAFT] Limpiando items existentes...');
                itemsBody.innerHTML = '';

                console.log(`[DRAFT] Agregando ${items.length} items...`);
                items.forEach((item, index) => {
                    // Verificar que agregarItem existe
                    if (typeof agregarItem === 'function') {
                        agregarItem();
                        const row = itemsBody.lastElementChild;

                        if (row) {
                            const descField = row.querySelector('[name="descripcion"]');
                            const unidadField = row.querySelector('[name="unidad"]');
                            const cantField = row.querySelector('[name="cantidad"]');
                            const precioField = row.querySelector('[name="precioUnitario"]');

                            if (descField) descField.value = item.descripcion || '';
                            if (unidadField) unidadField.value = item.unidad || '';
                            if (cantField) cantField.value = item.cantidad || 0;
                            if (precioField) precioField.value = item.precioUnitario || 0;

                            // Disparar eventos para actualizar cálculos
                            if (cantField) cantField.dispatchEvent(new Event('input', { bubbles: true }));
                            if (precioField) precioField.dispatchEvent(new Event('input', { bubbles: true }));

                            console.log(`[DRAFT] Item ${index + 1} agregado:`, item.descripcion);
                        }
                    } else {
                        console.error('[DRAFT] Función agregarItem() no encontrada');
                    }
                });
            } else if (items.length === 0) {
                console.log('[DRAFT] No hay items para cargar');
            } else {
                console.error('[DRAFT] items-body no encontrado');
            }

            // Llenar condiciones con verificación
            let condicionesLlenadas = 0;
            Object.keys(condiciones).forEach(key => {
                const elemento = document.querySelector(`[name="${key}"]`);
                if (elemento) {
                    if (condiciones[key] !== null && condiciones[key] !== undefined) {
                        elemento.value = condiciones[key];
                        elemento.dispatchEvent(new Event('change', { bubbles: true }));
                        condicionesLlenadas++;
                        console.log(`[DRAFT] Condición ${key} llenada:`, condiciones[key]);
                    }
                } else {
                    console.warn(`[DRAFT] Campo condición ${key} no encontrado`);
                }
            });
            console.log(`[DRAFT] ${condicionesLlenadas} condiciones llenadas`);

            // Recalcular totales
            console.log('[DRAFT] Recalculando totales...');
            if (typeof calcularTotales === 'function') {
                calcularTotales();
                console.log('[DRAFT] Totales recalculados');
            } else {
                console.warn('[DRAFT] Función calcularTotales() no encontrada');
            }

            formModificado = false;

            console.log('[DRAFT] ✅ Draft cargado exitosamente:', draftId);
            console.log('[DRAFT] Resumen:', {
                camposGenerales: camposLlenados,
                items: items.length,
                condiciones: condicionesLlenadas
            });

            alert(`Borrador "${draft.nombre}" cargado exitosamente\n\nCampos: ${camposLlenados}\nItems: ${items.length}\nCondiciones: ${condicionesLlenadas}`);

        } else {
            throw new Error(resultado.error || 'Draft no encontrado');
        }

    } catch (error) {
        console.error('[DRAFT] ❌ Error cargando draft:', error);
        alert(`Error al cargar borrador: ${error.message}`);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const fechaElement = document.getElementById('fecha-actual');
    if (fechaElement) {
        fechaElement.textContent = new Date().toLocaleDateString('es-MX', {
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
        });
    }

    // FORZAR: Asegurar que el campo numeroCotizacion NO sea required y esté disabled
    const campoNumeroCotizacion = document.querySelector('[name="numeroCotizacion"]');
    if (campoNumeroCotizacion) {
        campoNumeroCotizacion.removeAttribute('required');
        campoNumeroCotizacion.setAttribute('disabled', 'disabled');
        console.log('Campo numeroCotizacion configurado como disabled sin required');
    }

    // Cargar datos precargados si existen
    if (DATOS_PRECARGADOS) {
        cargarDatosPrecargados();
    }
    setTimeout(() => { agregarItem(); }, 500);
    configurarEventListeners();

    // Inicializar modal de revisión si es necesario
    inicializarModalRevision();

    // Inicializar sistema de auto-guardado de drafts
    inicializarSistemaAutoGuardado();

    // Cargar draft si viene en URL (?draft=ID)
    const urlParams = new URLSearchParams(window.location.search);
    const draftId = urlParams.get('draft');
    if (draftId) {
        console.log('[DRAFT] Draft ID detectado en URL:', draftId);
        setTimeout(() => {
            cargarDraftSeleccionado(draftId);
        }, 1000); // Esperar a que todo se inicialice
    }
});

// ============================================
// SISTEMA DE MODAL DE DESCRIPCIÓN DE REVISIÓN
// ============================================

function mostrarModalRevisionBloqueada() {
    const modal = document.getElementById('modal-revision-bloqueada');
    const historialLista = document.getElementById('historial-revisiones-lista');
    const btnIrUltima = document.getElementById('btn-ir-ultima-revision');
    const btnVolver = document.getElementById('btn-volver-busqueda');
    const formularioPrincipal = document.getElementById('cotizacion-form');

    if (!modal || !INFO_BLOQUEO_REVISION) {
        console.error('[MODAL_BLOQUEO] Error: elementos no encontrados');
        return;
    }

    // Deshabilitar formulario principal
    formularioPrincipal.classList.add('form-disabled');

    // Generar historial de revisiones
    const historial = INFO_BLOQUEO_REVISION.historial || [];
    console.log('[MODAL_BLOQUEO] Historial de revisiones:', historial);

    historialLista.innerHTML = '';

    if (historial.length === 0) {
        historialLista.innerHTML = '<p class="text-sm text-gray-500">No hay historial disponible</p>';
    } else {
        historial.forEach((rev, index) => {
            const esUltima = rev.revision === INFO_BLOQUEO_REVISION.revision_maxima;

            const itemDiv = document.createElement('div');
            itemDiv.className = `p-3 rounded border ${esUltima ? 'bg-green-50 border-green-300' : 'bg-white border-gray-200'}`;

            const headerDiv = document.createElement('div');
            headerDiv.className = 'flex items-center justify-between mb-1';

            const revisionSpan = document.createElement('span');
            revisionSpan.className = `font-semibold text-sm ${esUltima ? 'text-green-800' : 'text-gray-700'}`;
            revisionSpan.textContent = `R${rev.revision}`;

            if (esUltima) {
                const badge = document.createElement('span');
                badge.className = 'text-xs bg-green-600 text-white px-2 py-1 rounded';
                badge.textContent = 'Más reciente';
                headerDiv.appendChild(badge);
            }

            headerDiv.insertBefore(revisionSpan, headerDiv.firstChild);

            const justificacionP = document.createElement('p');
            justificacionP.className = 'text-xs text-gray-600 mt-1';
            justificacionP.textContent = rev.justificacion || 'Sin justificación';

            itemDiv.appendChild(headerDiv);
            itemDiv.appendChild(justificacionP);

            historialLista.appendChild(itemDiv);
        });
    }

    // Mostrar modal
    modal.style.display = 'flex';

    // Event listener para ir a última revisión
    btnIrUltima.addEventListener('click', function() {
        console.log('[MODAL_BLOQUEO] Redirigiendo a última revisión:', INFO_BLOQUEO_REVISION.numero_ultima_revision);
        window.location.href = `/formulario?revision=${encodeURIComponent(INFO_BLOQUEO_REVISION.numero_ultima_revision)}`;
    });

    // Event listener para volver a búsqueda
    btnVolver.addEventListener('click', function() {
        console.log('[MODAL_BLOQUEO] Volviendo a búsqueda');
        window.location.href = '/';
    });
}

function inicializarModalRevision() {
    // Verificar primero si la revisión está bloqueada
    if (INFO_BLOQUEO_REVISION && INFO_BLOQUEO_REVISION.bloqueada) {
        console.log('[MODAL_BLOQUEO] Revisión bloqueada, mostrando modal de advertencia');
        mostrarModalRevisionBloqueada();
        return;
    }

    // Solo mostrar modal si es una revisión (DATOS_PRECARGADOS existe)
    if (!DATOS_PRECARGADOS) {
        console.log('[MODAL_REVISION] No es una revisión, modal no se mostrará');
        return;
    }

    const datosGenerales = DATOS_PRECARGADOS.datosGenerales || {};
    const numeroRevision = datosGenerales.revision || 2;

    console.log('[MODAL_REVISION] Es una revisión R' + numeroRevision + ', mostrando modal');

    // Elementos del modal
    const modal = document.getElementById('modal-revision');
    const numeroRevisionSpan = document.getElementById('numero-revision-modal');
    const descripcionInput = document.getElementById('descripcion-revision-input');
    const btnConfirmar = document.getElementById('btn-confirmar-revision');
    const contadorCaracteres = document.getElementById('contador-caracteres');
    const errorDescripcion = document.getElementById('error-descripcion');
    const formularioPrincipal = document.getElementById('cotizacion-form');

    if (!modal || !descripcionInput || !btnConfirmar) {
        console.error('[MODAL_REVISION] Error: elementos del modal no encontrados');
        return;
    }

    // Configurar número de revisión en el modal
    numeroRevisionSpan.textContent = 'R' + numeroRevision;

    // Deshabilitar formulario principal
    formularioPrincipal.classList.add('form-disabled');
    console.log('[MODAL_REVISION] Formulario principal deshabilitado');

    // Mostrar modal
    modal.style.display = 'flex';

    // Event listener para contador de caracteres y validación
    descripcionInput.addEventListener('input', function() {
        const texto = descripcionInput.value.trim();
        const longitudTexto = texto.length;

        // Actualizar contador
        contadorCaracteres.textContent = longitudTexto;

        // Validar y habilitar/deshabilitar botón
        if (longitudTexto >= 10) {
            btnConfirmar.disabled = false;
            errorDescripcion.style.display = 'none';
            descripcionInput.style.borderColor = '';
        } else {
            btnConfirmar.disabled = true;
        }
    });

    // Event listener para botón de confirmar
    btnConfirmar.addEventListener('click', function() {
        const descripcion = descripcionInput.value.trim();

        // Validar longitud mínima
        if (descripcion.length < 10) {
            errorDescripcion.style.display = 'block';
            descripcionInput.style.borderColor = '#dc2626';
            descripcionInput.focus();
            return;
        }

        // Rellenar campo de justificación con formato "Rev X: descripción"
        const actualizacionTextarea = document.querySelector('textarea[name="actualizacionRevision"]');
        if (actualizacionTextarea) {
            const textoJustificacion = `Rev ${numeroRevision}: ${descripcion}`;
            actualizacionTextarea.value = textoJustificacion;
            console.log('[MODAL_REVISION] Justificación rellenada:', textoJustificacion);
        }

        // Cerrar modal
        modal.style.display = 'none';

        // Habilitar formulario principal
        formularioPrincipal.classList.remove('form-disabled');
        console.log('[MODAL_REVISION] Formulario principal habilitado');

        // Mostrar mensaje de confirmación
        console.log('[MODAL_REVISION] Modal cerrado, descripción guardada');
    });

    // Enfocar en el textarea al cargar
    setTimeout(() => {
        descripcionInput.focus();
    }, 300);
}

// ============================================
// SISTEMA DE DETECCIÓN DE CAMBIOS EN REVISIONES
// ============================================

function capturarEstadoFormulario() {
    const estado = {
        datosGenerales: {},
        items: [],
        condiciones: {}
    };

    // Capturar datos generales (excepto revisión y justificación)
    const camposDatosGenerales = ['vendedor', 'proyecto', 'cliente', 'atencionA', 'contacto', 'numeroCotizacion'];
    camposDatosGenerales.forEach(campo => {
        const elemento = document.querySelector(`[name="${campo}"]`);
        if (elemento) {
            estado.datosGenerales[campo] = elemento.value.trim();
        }
    });

    // Capturar condiciones
    const camposCondiciones = ['moneda', 'tipoCambio', 'tiempoEntrega', 'entregaEn', 'terminos', 'comentarios'];
    camposCondiciones.forEach(campo => {
        const elemento = document.querySelector(`[name="${campo}"]`);
        if (elemento) {
            estado.condiciones[campo] = elemento.value.trim();
        }
    });

    // Capturar items CON TODOS sus campos y materiales
    const itemsBlocks = document.querySelectorAll('.item-block');
    itemsBlocks.forEach((itemBlock, index) => {
        const item = {
            // Campos principales del item
            descripcion: itemBlock.querySelector('.descripcion-item')?.value || '',
            cantidad: itemBlock.querySelector('.cantidad-item')?.value || '',
            uom: itemBlock.querySelector('.uom-item')?.value || '',
            peso: itemBlock.querySelector('[name="peso[]"]')?.value || '',
            precio: itemBlock.querySelector('[name="precio[]"]')?.value || '',
            costoUnidad: itemBlock.querySelector('.costo-unidad')?.value || '',
            totalItem: itemBlock.querySelector('.total-item')?.value || '',
            notas: itemBlock.querySelector('[name="notas[]"]')?.value || '',

            // Costos adicionales
            transporte: itemBlock.querySelector('.transporte')?.value || '',
            instalacion: itemBlock.querySelector('.instalacion')?.value || '',
            seguridad: itemBlock.querySelector('.seguridad')?.value || '',
            descuento: itemBlock.querySelector('.descuento')?.value || '',

            // Materiales
            materiales: [],
            otrosMateriales: []
        };

        // Capturar materiales
        itemBlock.querySelectorAll('.materiales-container .material-row').forEach(row => {
            const material = row.querySelector('.material-select')?.value || '';
            if (material && material.trim() !== "") {
                const materialData = {
                    material: material,
                    cantidad: row.querySelector('.cantidad-material')?.value || '',
                    precio: row.querySelector('.precio-material')?.value || '',
                    subtotal: row.querySelector('.subtotal-material')?.value || ''
                };

                // Si es cotización por peso, capturar campos adicionales
                if (material === 'COTIZAR_POR_PESO') {
                    materialData.pesoEstructura = row.querySelector('.peso-estructura-input')?.value || '';
                    materialData.precioKg = row.querySelector('.precio-kg-input')?.value || '';
                }

                item.materiales.push(materialData);
            }
        });

        // Capturar otros materiales
        itemBlock.querySelectorAll('.otros-materiales-container .otro-material-row').forEach(row => {
            const descripcion = row.querySelector('.descripcion-otro')?.value?.trim() || '';
            if (descripcion !== "") {
                item.otrosMateriales.push({
                    descripcion: descripcion,
                    precio: row.querySelector('.precio-otro')?.value || '',
                    cantidad: row.querySelector('.cantidad-otro')?.value || '',
                    subtotal: row.querySelector('.subtotal-otro')?.value || ''
                });
            }
        });

        estado.items.push(item);
    });

    return estado;
}

function compararEstados(estadoInicial, estadoActual) {
    // Comparar como JSON para facilitar la comparación profunda
    const jsonInicial = JSON.stringify(estadoInicial);
    const jsonActual = JSON.stringify(estadoActual);
    return jsonInicial === jsonActual;
}

function formularioTieneCambios() {
    if (!estadoInicialFormulario) {
        // Si no hay estado inicial, asumimos que hay cambios (cotización nueva)
        console.log('[DETECCION_CAMBIOS] No hay estado inicial - es cotización nueva');
        return true;
    }

    const estadoActual = capturarEstadoFormulario();
    const sinCambios = compararEstados(estadoInicialFormulario, estadoActual);

    console.log('[DETECCION_CAMBIOS] ====== COMPARACIÓN DE ESTADOS ======');
    console.log('[DETECCION_CAMBIOS] Estado inicial:', estadoInicialFormulario);
    console.log('[DETECCION_CAMBIOS] Estado actual:', estadoActual);
    console.log('[DETECCION_CAMBIOS] ¿Son idénticos?:', sinCambios);
    console.log('[DETECCION_CAMBIOS] ¿Hay cambios?:', !sinCambios);

    return !sinCambios; // Retorna true si HAY cambios
}

function manejarRevision() {
    const revisionInput = document.getElementById('revision');
    const actualizacionContainer = document.getElementById('actualizacion-container');
    const actualizacionTextarea = document.querySelector('textarea[name="actualizacionRevision"]');
    const revision = parseInt(revisionInput.value) || 1;
    
    if (revision >= 2) {
        actualizacionContainer.style.display = 'block';
        actualizacionTextarea.required = true;
    } else {
        actualizacionContainer.style.display = 'none';
        actualizacionTextarea.required = false;
        actualizacionTextarea.value = '';
    }
}

function configurarEventListeners() {
    document.addEventListener('input', function(e) {
        const itemElement = e.target.closest('.item-block');
        if (itemElement) {
            if (e.target.matches('.cantidad-input, .precio-input')) {
                calcularSubtotalMaterial(e.target);
            }
            if (e.target.matches('.precio-otro, .cantidad-otro')) {
                calcularSubtotalOtro(e.target);
            }
        }
    });
    
    // NUEVO: Event listener para cambios en dropdown de unidades
    document.addEventListener('change', function(e) {
        if (e.target.matches('.unidad-select')) {
            // Recalcular cuando cambia la unidad
            const row = e.target.closest('.material-row');
            if (row) {
                const cantidadInput = row.querySelector('.cantidad-input');
                if (cantidadInput) {
                    calcularSubtotalMaterial(cantidadInput);
                }
            }
        }
    });
    
    document.addEventListener('input', function(e) {
        const itemElement = e.target.closest('.item-block');
        if (itemElement) {
            if (e.target.matches('.cantidad-item, .transporte, .instalacion, .seguridad, .descuento')) {
                setTimeout(() => {
                    calcularCostosItem(itemElement);
                    actualizarTodosLosCalculos();
                }, 100);
            }
        }
        
        if (e.target.matches('input[placeholder="Ej. Rack Metálico"]')) {
            setTimeout(() => { actualizarTodosLosCalculos(); }, 100);
        }
        
        // Cálculo en tiempo real para campos de cotizar por peso
        if (e.target.matches('.peso-estructura-input, .precio-kg-input')) {
            calcularSubtotalPeso(e.target);
        }
        
        // Recalcular totales cuando cambia el tipo de cambio
        if (e.target.matches('#tipo-cambio')) {
            setTimeout(() => {
                actualizarTodosLosCalculos();
            }, 100);
        }
    });

    document.addEventListener('change', function(e) {
        if (e.target.matches('.material-select')) {
            const materialRow = e.target.closest('.material-row');
            const selectedOption = e.target.selectedOptions[0];
            const valorSeleccionado = e.target.value;
            
            // Detectar si se seleccionó "Cotizar por peso"
            if (valorSeleccionado === 'COTIZAR_POR_PESO') {
                toggleCotizarPorPeso(materialRow, true);
            } else {
                toggleCotizarPorPeso(materialRow, false);
                
                // Funcionalidad original para materiales normales
                const pesoInput = materialRow.querySelector('.peso-input');
                const peso = selectedOption?.getAttribute('data-peso') || 0;
                if (pesoInput) pesoInput.value = peso;
            }
            
            const itemElement = e.target.closest('.item-block');
            if (itemElement) {
                calcularCostosItem(itemElement);
                actualizarTodosLosCalculos();
            }
        }
    });
}

function cargarDatosPrecargados() {
    if (!DATOS_PRECARGADOS) return;
    
    
    try {
        // Cargar datos generales
        const datosGenerales = DATOS_PRECARGADOS.datosGenerales || {};
        
        // Campos de datos generales
        const campos = {
            'cliente': datosGenerales.cliente,
            'atencionA': datosGenerales.atencionA,
            'contacto': datosGenerales.contacto,
            'vendedor': datosGenerales.vendedor,
            'numeroCotizacion': datosGenerales.numeroCotizacion,
            'revision': datosGenerales.revision,
            'proyecto': datosGenerales.proyecto,
            'fecha': datosGenerales.fecha,
            'moneda': datosGenerales.moneda,
            'tipoCambio': datosGenerales.tipoCambio,
            'tiempoEntrega': datosGenerales.tiempoEntrega,
            'entregaEn': datosGenerales.entregaEn,
            'terminos': datosGenerales.terminos,
            'comentarios': datosGenerales.comentarios,
            'actualizacionRevision': datosGenerales.actualizacionRevision
        };
        
        // Llenar campos del formulario
        Object.entries(campos).forEach(([campo, valor]) => {
            if (valor !== undefined && valor !== null) {
                const elemento = document.getElementById(campo) || document.querySelector(`[name="${campo}"]`);
                if (elemento) {
                    elemento.value = valor;
                }
            }
        });
        
        // FIX ISSUE #1: Establecer también el campo hidden para revisiones
        if (datosGenerales.numeroCotizacion) {
            const campoHidden = document.querySelector('[name="numeroCotizacionHidden"]');
            if (campoHidden) {
                campoHidden.value = datosGenerales.numeroCotizacion;
                console.log('[REVISION] Campo hidden establecido:', datosGenerales.numeroCotizacion);
            }
        }
        
        // Cargar condiciones/términos
        if (DATOS_PRECARGADOS.condiciones) {
            const condiciones = DATOS_PRECARGADOS.condiciones;
            const camposCondiciones = {
                'moneda': condiciones.moneda,
                'tipoCambio': condiciones.tipoCambio,
                'tiempoEntrega': condiciones.tiempoEntrega,
                'entregaEn': condiciones.entregaEn,
                'terminos': condiciones.terminos || condiciones.terminosPago,
                'comentarios': condiciones.comentarios
            };
            
            Object.entries(camposCondiciones).forEach(([campo, valor]) => {
                if (valor !== undefined && valor !== null) {
                    const elemento = document.querySelector(`[name="${campo}"]`);
                    if (elemento) {
                        elemento.value = valor;
                    }
                }
            });
        }
        
        // Mostrar campo de justificación si es revisión >= 2
        setTimeout(() => {
            manejarRevision();
        }, 100);
        
        // Cargar items
        if (DATOS_PRECARGADOS.items && DATOS_PRECARGADOS.items.length > 0) {
            // Limpiar items existentes
            const container = document.getElementById('items-container');
            if (container) {
                container.innerHTML = '';
            }
            
            // Agregar cada item
            DATOS_PRECARGADOS.items.forEach((item, index) => {
                setTimeout(() => {
                    agregarItem();
                    cargarDatosItem(item, index);
                }, index * 100);
            });
        }
        
        // Mostrar mensaje de éxito
        setTimeout(() => {
            mostrarNotificacion('Datos cargados para nueva revisión', 'success');
        }, 500);

        // Colapsar items vacíos después de cargar todos los datos
        const numItems = DATOS_PRECARGADOS.items ? DATOS_PRECARGADOS.items.length : 0;
        const tiempoParaColapsar = Math.max(1500, numItems * 100);

        setTimeout(() => {
            colapsarItemsVacios();
        }, tiempoParaColapsar);

        // Capturar estado inicial después de cargar todos los datos
        // Usamos un timeout largo para asegurar que todos los items se hayan cargado
        const tiempoEspera = Math.max(2000, numItems * 150); // Mínimo 2 segundos, más tiempo si hay muchos items

        setTimeout(() => {
            estadoInicialFormulario = capturarEstadoFormulario();
            console.log('[DETECCION_CAMBIOS] ====== ESTADO INICIAL CAPTURADO ======');
            console.log('[DETECCION_CAMBIOS] Número de items:', estadoInicialFormulario.items.length);
            console.log('[DETECCION_CAMBIOS] Estado completo:', estadoInicialFormulario);
            console.log('[DETECCION_CAMBIOS] Items con materiales:',
                estadoInicialFormulario.items.map(item => ({
                    desc: item.descripcion,
                    numMateriales: item.materiales.length,
                    numOtrosMateriales: item.otrosMateriales.length
                }))
            );
        }, tiempoEspera);

    } catch (error) {
        console.error('Error cargando datos precargados:', error);
        mostrarNotificacion('Error cargando algunos datos', 'warning');
    }
}

// ============================================
// FUNCIÓN PARA COLAPSAR ITEMS VACÍOS EN REVISIONES
// ============================================

function itemEstaVacio(itemElement) {
    // Verificar si un item está vacío (sin información significativa)

    // Verificar descripción
    const descripcion = itemElement.querySelector('.descripcion-item')?.value?.trim() || '';
    if (descripcion !== '') return false;

    // Verificar cantidad
    const cantidad = itemElement.querySelector('.cantidad-item')?.value || '0';
    if (parseFloat(cantidad) > 0) return false;

    // Verificar materiales
    const materiales = itemElement.querySelectorAll('.materiales-container .material-row');
    let tieneMateriales = false;
    materiales.forEach(row => {
        const material = row.querySelector('.material-select')?.value || '';
        if (material && material.trim() !== '') {
            tieneMateriales = true;
        }
    });
    if (tieneMateriales) return false;

    // Verificar otros materiales
    const otrosMateriales = itemElement.querySelectorAll('.otros-materiales-container .otro-material-row');
    let tieneOtrosMateriales = false;
    otrosMateriales.forEach(row => {
        const descripcion = row.querySelector('.descripcion-otro')?.value?.trim() || '';
        if (descripcion !== '') {
            tieneOtrosMateriales = true;
        }
    });
    if (tieneOtrosMateriales) return false;

    // Verificar notas
    const notas = itemElement.querySelector('[name="notas[]"]')?.value?.trim() || '';
    if (notas !== '') return false;

    // Si llegamos aquí, el item está vacío
    return true;
}

function colapsarItemsVacios() {
    const items = document.querySelectorAll('.item-block');
    let itemsColapsados = 0;
    let itemsExpandidos = 0;

    items.forEach((item, index) => {
        if (itemEstaVacio(item)) {
            // Remover el atributo 'open' para colapsar
            item.removeAttribute('open');
            itemsColapsados++;
            console.log(`[COLAPSO] Item ${index + 1}: Colapsado (vacío)`);
        } else {
            itemsExpandidos++;
            console.log(`[COLAPSO] Item ${index + 1}: Expandido (tiene datos)`);
        }
    });

    console.log(`[COLAPSO] Resumen: ${itemsExpandidos} items con datos (expandidos), ${itemsColapsados} items vacíos (colapsados)`);
}

function cargarDatosItem(itemData, index) {
    try {
        const items = document.querySelectorAll('.item-block');
        const item = items[index];
        
        if (!item) return;
        
        // Cargar descripción
        const descripcion = item.querySelector('.descripcion-item');
        if (descripcion && itemData.descripcion) {
            descripcion.value = itemData.descripcion;
        }
        
        // Cargar cantidad
        const cantidad = item.querySelector('.cantidad-item');
        if (cantidad && itemData.cantidad !== undefined) {
            cantidad.value = itemData.cantidad;
        }
        
        // Cargar UOM
        const uom = item.querySelector('.uom-item');
        if (uom && itemData.uom) {
            uom.value = itemData.uom;
        }
        
        // Cargar costos adicionales
        const campos_costos = ['transporte', 'instalacion', 'seguridad', 'descuento'];
        campos_costos.forEach(campo => {
            const elemento = item.querySelector(`.${campo}`);
            if (elemento && itemData[campo] !== undefined) {
                elemento.value = itemData[campo];
            }
        });
        
        // Cargar materiales
        if (itemData.materiales && itemData.materiales.length > 0) {
            setTimeout(() => {
                cargarMaterialesItem(item, itemData.materiales, 'materiales');
            }, 500);
        }
        
        // Cargar otros materiales
        if (itemData.otrosMateriales && itemData.otrosMateriales.length > 0) {
            setTimeout(() => {
                cargarMaterialesItem(item, itemData.otrosMateriales, 'otrosMateriales');
            }, 800);
        }
        
    } catch (error) {
        console.error(`Error cargando item ${index}:`, error);
    }
}

function cargarMaterialesItem(itemElement, materiales, tipo) {
    try {
        
        // Buscar botón de agregar material de forma más flexible
        let botonAgregar;
        if (tipo === 'materiales') {
            botonAgregar = itemElement.querySelector('[onclick*="agregarFila"][onclick*="material"]');
        } else {
            botonAgregar = itemElement.querySelector('[onclick*="agregarFila"][onclick*="otro"]');
        }
        
        if (!botonAgregar) {
            // Intentar encontrar por texto del botón
            const botones = itemElement.querySelectorAll('button');
            
            for (let btn of botones) {
                const onclick = btn.getAttribute('onclick') || '';
                
                if (tipo === 'materiales' && onclick.includes('agregarFila') && onclick.includes('material')) {
                    botonAgregar = btn;
                    break;
                } else if (tipo === 'otrosMateriales' && onclick.includes('agregarFila') && onclick.includes('otro')) {
                    botonAgregar = btn;
                    break;
                }
            }
        }
        
        if (!botonAgregar) {
            console.error(`No se pudo encontrar botón para ${tipo}`);
            return;
        }
        
        // Agregar cada material
        materiales.forEach((material, index) => {
            
            setTimeout(() => {
                // Verificar si necesitamos agregar una nueva fila o usar una existente vacía
                let necesitaClick = true;
                
                if (index === 0) {
                    // Para el primer material, verificar si ya hay una fila vacía
                    const filasExistentes = tipo === 'materiales' ? 
                        itemElement.querySelectorAll('.material-row, [class*="material-row"]:not([class*="otro"])') :
                        itemElement.querySelectorAll('.otro-material-row, [class*="otro-material"]');
                    
                    if (filasExistentes.length > 0) {
                        const primeraFila = filasExistentes[0];
                        const inputs = primeraFila.querySelectorAll('input');
                        const estaVacia = Array.from(inputs).every(input => !input.value.trim());
                        
                        if (estaVacia) {
                            necesitaClick = false;
                        }
                    }
                }
                
                if (necesitaClick) {
                    // Simular click en botón agregar material
                    botonAgregar.click();
                }
                
                // Llenar datos del material recién agregado
                setTimeout(() => {
                    // Buscar la fila correcta según el tipo de material
                    let ultimoMaterial = null;
                    let todasLasFilas = [];
                    
                    if (tipo === 'materiales') {
                        // Buscar en filas de materiales normales (que NO contengan "otro")
                        todasLasFilas = itemElement.querySelectorAll('.material-row:not(.otro-material-row), [class*="material-row"]:not([class*="otro"])');
                        
                        // Si no encuentra, intentar selector más específico
                        if (todasLasFilas.length === 0) {
                            // Buscar por filas que contengan inputs que NO sean .descripcion-otro
                            const todasFilas = itemElement.querySelectorAll('[class*="material"], [class*="row"]');
                            todasLasFilas = Array.from(todasFilas).filter(fila => {
                                const tieneInputOtro = fila.querySelector('.descripcion-otro');
                                return !tieneInputOtro; // Solo filas que NO tengan inputs de otros materiales
                            });
                        }
                    } else {
                        // Buscar en filas de otros materiales
                        todasLasFilas = itemElement.querySelectorAll('.otro-material-row, [class*="otro-material"]');
                    }
                    
                    
                    // Usar la fila correspondiente al índice del material
                    if (todasLasFilas.length > index) {
                        ultimoMaterial = todasLasFilas[index];
                    } else {
                        // Si no hay suficientes filas, usar la última disponible
                        ultimoMaterial = todasLasFilas[todasLasFilas.length - 1];
                    }
                    
                    if (ultimoMaterial) {
                        // Buscar campos de forma más específica según la estructura del formulario
                        const inputs = ultimoMaterial.querySelectorAll('input');
                        
                        let descripcion, precio, cantidad;
                        
                        // Identificar campos según el tipo de material
                        if (tipo === 'materiales') {
                            // Para materiales normales: buscar dropdown y campos específicos
                            descripcion = ultimoMaterial.querySelector('.material-select');
                            precio = ultimoMaterial.querySelector('.precio-input');
                            cantidad = ultimoMaterial.querySelector('.cantidad-input');
                        } else {
                            // Para otros materiales: usar la lógica original
                            inputs.forEach((input, idx) => {
                                const placeholder = input.placeholder?.toLowerCase() || '';
                                const type = input.type;
                                
                                if (type === 'text' || placeholder.includes('descripción')) {
                                    descripcion = input;
                                } else if (type === 'number' && (placeholder.includes('precio') || idx === 1)) {
                                    precio = input;
                                } else if (type === 'number' && (placeholder.includes('cantidad') || idx === 2)) {
                                    cantidad = input;
                                }
                            });
                        }
                        
                        // Verificar que tenemos datos válidos antes de continuar
                        const tieneDescripcion = material.material || material.descripcion || material.desc;
                        if (!tieneDescripcion) {
                            return;
                        }
                        
                        // Cargar datos - manejar diferentes formatos de descripción según el tipo
                        let desc = '';
                        if (tipo === 'materiales') {
                            // Para materiales normales, la descripción está en 'material'
                            desc = material.material || '';
                        } else {
                            // Para otros materiales, la descripción está en 'descripcion'
                            desc = material.descripcion || '';
                        }
                        
                        if (descripcion && desc) {
                            if (tipo === 'materiales') {
                                // Verificar si es "Cotizar por peso"
                                if (esCotizacionPorPeso(desc) || esCotizacionPorPeso(material)) {
                                    // Seleccionar la opción "Cotizar por peso"
                                    descripcion.value = 'COTIZAR_POR_PESO';
                                    
                                    // Activar modo cotizar por peso
                                    toggleCotizarPorPeso(ultimoMaterial, true);
                                    
                                    // Cargar datos específicos de peso
                                    const pesoEstructuraInput = ultimoMaterial.querySelector('.peso-estructura-input');
                                    const precioKgInput = ultimoMaterial.querySelector('.precio-kg-input');
                                    const subtotalPesoInput = ultimoMaterial.querySelector('.subtotal-peso-input');
                                    
                                    if (pesoEstructuraInput && material.pesoEstructura !== undefined) {
                                        pesoEstructuraInput.value = material.pesoEstructura;
                                    }
                                    if (precioKgInput && material.precioKg !== undefined) {
                                        precioKgInput.value = material.precioKg;
                                    }
                                    if (subtotalPesoInput && material.subtotal !== undefined) {
                                        subtotalPesoInput.value = material.subtotal;
                                    }
                                } else {
                                    // Para materiales normales: seleccionar opción en dropdown
                                    const opciones = descripcion.querySelectorAll('option');
                                    let opcionEncontrada = false;
                                    
                                    // Función para normalizar texto (quitar espacios extra, mayúsculas, etc.)
                                    function normalizar(texto) {
                                        return texto.trim().toLowerCase().replace(/\s+/g, ' ');
                                    }
                                    
                                    const descNormalizado = normalizar(desc);
                                    
                                    // 1. Buscar coincidencia exacta por valor
                                    for (let opcion of opciones) {
                                        if (opcion.value === desc) {
                                            descripcion.value = opcion.value;
                                            opcionEncontrada = true;
                                            // CRÍTICO: Actualizar peso inmediatamente después de seleccionar
                                            const pesoValor = opcion.getAttribute('data-peso') || 1;
                                            const pesoInput = ultimoMaterial.querySelector('.peso-input');
                                            if (pesoInput) {
                                                pesoInput.value = pesoValor;
                                            }
                                            break;
                                        }
                                    }
                                    
                                    // 2. Buscar coincidencia normalizada
                                    if (!opcionEncontrada) {
                                        for (let opcion of opciones) {
                                            if (normalizar(opcion.value) === descNormalizado || 
                                                normalizar(opcion.textContent) === descNormalizado) {
                                                descripcion.value = opcion.value;
                                                opcionEncontrada = true;
                                                // CRÍTICO: Actualizar peso inmediatamente
                                                const pesoValor = opcion.getAttribute('data-peso') || 1;
                                                const pesoInput = ultimoMaterial.querySelector('.peso-input');
                                                if (pesoInput) {
                                                    pesoInput.value = pesoValor;
                                                }
                                                break;
                                            }
                                        }
                                    }
                                    
                                    // 3. Buscar coincidencia parcial flexible
                                    if (!opcionEncontrada) {
                                        for (let opcion of opciones) {
                                            const opcionNormalizada = normalizar(opcion.textContent);
                                            if (opcionNormalizada.includes(descNormalizado) || 
                                                descNormalizado.includes(opcionNormalizada)) {
                                                descripcion.value = opcion.value;
                                                opcionEncontrada = true;
                                                // CRÍTICO: Actualizar peso inmediatamente
                                                const pesoValor = opcion.getAttribute('data-peso') || 1;
                                                const pesoInput = ultimoMaterial.querySelector('.peso-input');
                                                if (pesoInput) {
                                                    pesoInput.value = pesoValor;
                                                }
                                                break;
                                            }
                                        }
                                    }
                                    
                                    // 4. Fallback: crear opción dinámica si no existe
                                    if (!opcionEncontrada && desc.trim()) {
                                        const nuevaOpcion = document.createElement('option');
                                        nuevaOpcion.value = desc;
                                        nuevaOpcion.textContent = desc;
                                        nuevaOpcion.setAttribute('data-peso', material.peso || '1');
                                        nuevaOpcion.setAttribute('data-uom', material.uom || '');
                                        descripcion.appendChild(nuevaOpcion);
                                        descripcion.value = desc;
                                        opcionEncontrada = true;
                                        // Actualizar peso para opciones dinámicas
                                        const pesoInput = ultimoMaterial.querySelector('.peso-input');
                                        if (pesoInput) {
                                            pesoInput.value = material.peso || '1';
                                        }
                                    }
                                }
                            } else {
                                // Para otros materiales: asignar a input de texto
                                descripcion.value = desc;
                            }
                        }
                        
                        // Solo cargar precio y cantidad para materiales normales (no "Cotizar por peso")
                        if (!esCotizacionPorPeso(desc) && !esCotizacionPorPeso(material)) {
                            if (precio && material.precio !== undefined) {
                                precio.value = material.precio;
                                // Disparar eventos para recálculo
                                precio.dispatchEvent(new Event('input', { bubbles: true }));
                                precio.dispatchEvent(new Event('change', { bubbles: true }));
                            }
                            
                            if (cantidad && material.cantidad !== undefined) {
                                cantidad.value = material.cantidad;
                                // Disparar eventos para recálculo
                                cantidad.dispatchEvent(new Event('input', { bubbles: true }));
                                cantidad.dispatchEvent(new Event('change', { bubbles: true }));
                            }
                        }
                        
                        // CRÍTICO: Forzar recálculo después de cargar todos los datos
                        setTimeout(() => {
                            // Asegurar que todos los valores están disponibles antes del cálculo
                            if (tipo === 'materiales') {
                                // Verificar si es "Cotizar por peso" para usar la función correcta
                                if (esCotizacionPorPeso(desc) || esCotizacionPorPeso(material)) {
                                    // Para cotizar por peso, usar los inputs específicos
                                    const triggerInput = ultimoMaterial.querySelector('.peso-estructura-input, .precio-kg-input');
                                    if (triggerInput) {
                                        calcularSubtotalPeso(triggerInput);
                                    }
                                } else {
                                    // Para materiales normales
                                    const triggerInput = cantidad || precio || ultimoMaterial.querySelector('.cantidad-input, .precio-input');
                                    if (triggerInput) {
                                        calcularSubtotalMaterial(triggerInput);
                                    }
                                }
                            } else {
                                // Para otros materiales
                                const triggerInput = cantidad || precio || ultimoMaterial.querySelector('.cantidad-otro, .precio-otro');
                                if (triggerInput) {
                                    calcularSubtotalOtro(triggerInput);
                                }
                            }
                            
                            // Asegurar que se recalculan los totales del item
                            const itemElement = ultimoMaterial.closest('.item-block');
                            if (itemElement) {
                                calcularCostosItem(itemElement);
                                actualizarTodosLosCalculos();
                            }
                        }, 200); // Más tiempo para asegurar que todos los valores están establecidos
                    }
                }, 200);
            }, index * 500); // Más tiempo entre materiales para evitar solapamientos
        });
        
        // CRÍTICO: Forzar recálculo completo después de cargar todos los materiales
        setTimeout(() => {
            console.log(`Recalculando totales después de cargar ${tipo}`);
            
            // Buscar todos los campos de materiales cargados y forzar recálculo
            const materialesRows = itemElement.querySelectorAll('.material-row, .otro-material-row');
            materialesRows.forEach(row => {
                const inputsNumericos = row.querySelectorAll('input[type="number"]');
                if (inputsNumericos.length > 0) {
                    // Disparar recálculo en el primer input numérico encontrado
                    const primerInput = inputsNumericos[0];
                    if (tipo === 'materiales') {
                        // Verificar si la fila es "Cotizar por peso"
                        const materialSelect = row.querySelector('.material-select');
                        if (materialSelect && esCotizacionPorPeso(materialSelect.value)) {
                            // Es cotizar por peso, usar función específica
                            const pesoInput = row.querySelector('.peso-estructura-input, .precio-kg-input');
                            if (pesoInput) {
                                calcularSubtotalPeso(pesoInput);
                            }
                        } else {
                            // Es material normal
                            calcularSubtotalMaterial(primerInput);
                        }
                    } else {
                        calcularSubtotalOtro(primerInput);
                    }
                }
            });
            
            // CRÍTICO: Configurar event listeners para todos los inputs de materiales recién cargados
            const filasRecienCargadas = tipo === 'materiales' ? 
                itemElement.querySelectorAll('.material-row, [class*="material-row"]:not([class*="otro"])') :
                itemElement.querySelectorAll('.otro-material-row, [class*="otro-material"]');
                
            filasRecienCargadas.forEach(fila => {
                const inputs = fila.querySelectorAll('input[type="number"]');
                inputs.forEach(input => {
                    // Remover listeners previos para evitar duplicados
                    input.removeEventListener('input', calcularSubtotalMaterial);
                    input.removeEventListener('input', calcularSubtotalOtro);
                    
                    // Agregar listeners según el tipo
                    if (tipo === 'materiales') {
                        input.addEventListener('input', function() {
                            calcularSubtotalMaterial(this);
                        });
                    } else {
                        input.addEventListener('input', function() {
                            calcularSubtotalOtro(this);
                        });
                    }
                });
            });
            
            // Forzar recálculo inicial de todos los subtotales
            filasRecienCargadas.forEach(fila => {
                const primerInput = fila.querySelector('input[type="number"]');
                if (primerInput) {
                    if (tipo === 'materiales') {
                        calcularSubtotalMaterial(primerInput);
                    } else {
                        calcularSubtotalOtro(primerInput);
                    }
                }
            });
            
            // Recálculo final del item completo
            calcularCostosItem(itemElement);
            actualizarTodosLosCalculos();
            
        }, (materiales.length * 500) + 1000); // Esperar que terminen todos los materiales
        
    } catch (error) {
        console.error(`Error cargando ${tipo}:`, error);
    }
}

function mostrarNotificacion(mensaje, tipo = 'info') {
    const notif = document.createElement('div');
    notif.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 9999;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    
    const colores = {
        'success': '#10b981',
        'warning': '#f59e0b',
        'error': '#dc2626',
        'info': '#4f46e5'
    };
    
    notif.style.backgroundColor = colores[tipo] || colores.info;
    notif.textContent = mensaje;
    
    document.body.appendChild(notif);
    
    setTimeout(() => {
        if (notif.parentNode) {
            notif.parentNode.removeChild(notif);
        }
    }, 3000);
}

function agregarItem() {
    const container = document.getElementById('items-container');
    if (!container) return;
    
    const itemCount = container.children.length + 1;
    const template = crearTemplateItem(itemCount);
    container.insertAdjacentHTML('beforeend', template);
    setTimeout(() => { actualizarTodosLosCalculos(); }, 100);
}

function crearTemplateItem(numero) {
    return `
    <details class="item-block border rounded-lg p-4 bg-gray-50" open>
        <summary class="cursor-pointer font-semibold text-lg text-blue-700 hover:text-blue-800">📋 Item ${numero}</summary>
        
        <div class="mt-4 space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium mb-1">Descripción:</label>
                    <input type="text" class="descripcion-item w-full p-2 border rounded text-sm" placeholder="Ej. Rack Metálico">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="block text-sm font-medium mb-1">UOM:</label>
                        <select class="uom-item w-full p-2 border rounded text-sm">
                            <option value="Pieza">Pieza</option>
                            <option value="Servicio">Servicio</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Cantidad:</label>
                        <input type="number" step="0.01" class="cantidad-item w-full p-2 border rounded text-sm">
                    </div>
                </div>
            </div>

            <div class="border-t pt-4">
                <h3 class="text-lg font-semibold text-blue-600 mb-3">🔧 Materiales</h3>
                <div class="materiales-container space-y-2">
                    <div class="material-row flex gap-2 items-end">
                        <div class="w-1/4">
                            <label class="block text-xs mb-1">Material:</label>
                            <select class="material-select w-full p-2 border rounded text-sm">
                                <option value="" data-peso="0" data-uom="">Seleccione Material</option>
                                <option value="COTIZAR_POR_PESO" data-peso="0" data-uom="KG">Cotizar por peso</option>
                                {% for material in materiales %}
                                <option value="{{ material.descripcion }}" data-peso="{{ material.peso }}" data-uom="{{ material.uom }}">{{ material.descripcion }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Campos normales de materiales -->
                        <div class="material-campos-normales flex-1 grid grid-cols-5 gap-2">
                            <div>
                                <label class="block text-xs mb-1">Peso/Kg:</label>
                                <input type="number" step="0.01" class="peso-input w-full p-2 border rounded text-sm bg-gray-100" readonly>
                            </div>
                            <div>
                                <label class="block text-xs mb-1">Cantidad:</label>
                                <input type="number" step="0.01" class="cantidad-input w-full p-2 border rounded text-sm">
                            </div>
                            <div>
                                <label class="block text-xs mb-1">Unidad:</label>
                                <select class="unidad-select w-full p-2 border rounded text-sm">
                                    <option value="metros">Metros</option>
                                    <option value="centimetros">Centímetros</option>
                                    <option value="pulgadas">Pulgadas</option>
                                    <option value="metros_cuadrados">Metros²</option>
                                    <option value="centimetros_cuadrados">Centímetros²</option>
                                    <option value="pulgadas_cuadradas">Pulgadas²</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs mb-1">$/Kg:</label>
                                <input type="number" step="0.01" class="precio-input w-full p-2 border rounded text-sm">
                            </div>
                            <div>
                                <label class="block text-xs mb-1">Subtotal ($):</label>
                                <input type="number" step="0.01" class="subtotal-input w-full p-2 border rounded text-sm bg-gray-100" readonly>
                            </div>
                        </div>
                        
                        <!-- Campos especiales para cotizar por peso (inicialmente ocultos) -->
                        <div class="material-campos-peso flex-1 grid grid-cols-3 gap-2" style="display: none;">
                            <div>
                                <label class="block text-xs mb-1">¿Cuál es el peso de la estructura? (KG):</label>
                                <input type="number" step="0.01" class="peso-estructura-input w-full p-2 border rounded text-sm" placeholder="Peso en KG">
                            </div>
                            <div>
                                <label class="block text-xs mb-1">$/Kg:</label>
                                <input type="number" step="0.01" class="precio-kg-input w-full p-2 border rounded text-sm" placeholder="Precio por kilogramo">
                            </div>
                            <div>
                                <label class="block text-xs mb-1">Subtotal ($):</label>
                                <input type="number" step="0.01" class="subtotal-peso-input w-full p-2 border rounded text-sm bg-green-50" readonly>
                            </div>
                        </div>
                        
                        <div class="w-10 flex justify-center">
                            <button type="button" onclick="eliminarFila(this, 'material')" class="text-red-500 hover:text-red-700 font-bold text-lg">✕</button>
                        </div>
                    </div>
                </div>
                <button type="button" onclick="agregarFila(this, 'material')" class="icon-btn success mt-2 text-sm">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                    </svg>
                </button>
            </div>

            <div class="border-t pt-4">
                <h3 class="text-lg font-semibold text-blue-600 mb-3">Otros Materiales</h3>
                <div class="otros-materiales-container space-y-2">
                    <div class="otro-material-row grid grid-cols-12 gap-2 items-end">
                        <div class="col-span-5">
                            <label class="block text-xs mb-1">Descripción:</label>
                            <input type="text" class="descripcion-otro w-full p-2 border rounded text-sm" placeholder="Descripción del material">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-xs mb-1">Precio ($):</label>
                            <input type="number" step="0.01" class="precio-otro w-full p-2 border rounded text-sm">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-xs mb-1">Cantidad:</label>
                            <input type="number" step="0.01" class="cantidad-otro w-full p-2 border rounded text-sm">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-xs mb-1">Subtotal ($):</label>
                            <input type="number" step="0.01" class="subtotal-otro w-full p-2 border rounded text-sm bg-gray-100" readonly>
                        </div>
                        <div class="col-span-1 flex justify-center">
                            <button type="button" onclick="eliminarFila(this, 'otro')" class="text-red-500 hover:text-red-700 font-bold text-lg">✕</button>
                        </div>
                    </div>
                </div>
                <button type="button" onclick="agregarFila(this, 'otro')" class="icon-btn success mt-2 text-sm">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                    </svg>
                </button>
            </div>

            <div class="border-t pt-4">
                <h3 class="text-lg font-semibold text-blue-600 mb-3">Costos y Totales</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Transporte ($):</label>
                        <input type="number" step="0.01" class="transporte w-full p-2 border rounded text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Instalación ($):</label>
                        <input type="number" step="0.01" class="instalacion w-full p-2 border rounded text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Seguridad (%):</label>
                        <input type="number" step="0.01" class="seguridad w-full p-2 border rounded text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Descuento (%):</label>
                        <input type="number" step="0.01" class="descuento w-full p-2 border rounded text-sm">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Costo por Unidad ($):</label>
                        <input type="number" step="0.01" class="costo-unidad w-full p-2 border rounded text-sm bg-green-50 font-semibold" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Total del Item ($):</label>
                        <input type="number" step="0.01" class="total-item w-full p-2 border rounded text-sm bg-blue-50 font-semibold" readonly>
                    </div>
                </div>
            </div>
        </div>
    </details>`;
}
function agregarFila(button, tipo) {
    const itemBlock = button.closest('.item-block');
    const container = tipo === 'material' 
        ? itemBlock.querySelector('.materiales-container')
        : itemBlock.querySelector('.otros-materiales-container');
    
    let nuevaFila = document.createElement('div');
    
    if (tipo === 'material') {
        nuevaFila.className = 'material-row flex gap-2 items-end';
        nuevaFila.innerHTML = `
            <div class="w-1/4">
                <label class="block text-xs mb-1">Material:</label>
                <select class="material-select w-full p-2 border rounded text-sm">
                    ${generarOpcionesMateriales()}
                </select>
            </div>
            
            <!-- Campos normales de materiales -->
            <div class="material-campos-normales flex-1 grid grid-cols-5 gap-2">
                <div>
                    <label class="block text-xs mb-1">Peso/Kg:</label>
                    <input type="number" step="0.01" class="peso-input w-full p-2 border rounded text-sm bg-gray-100" readonly>
                </div>
                <div>
                    <label class="block text-xs mb-1">Cantidad:</label>
                    <input type="number" step="0.01" class="cantidad-input w-full p-2 border rounded text-sm">
                </div>
                <div>
                    <label class="block text-xs mb-1">Unidad:</label>
                    <select class="unidad-select w-full p-2 border rounded text-sm">
                        <option value="metros">Metros</option>
                        <option value="centimetros">Centímetros</option>
                        <option value="pulgadas">Pulgadas</option>
                        <option value="metros_cuadrados">Metros²</option>
                        <option value="centimetros_cuadrados">Centímetros²</option>
                        <option value="pulgadas_cuadradas">Pulgadas²</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs mb-1">$/Kg:</label>
                    <input type="number" step="0.01" class="precio-input w-full p-2 border rounded text-sm">
                </div>
                <div>
                    <label class="block text-xs mb-1">Subtotal ($):</label>
                    <input type="number" step="0.01" class="subtotal-input w-full p-2 border rounded text-sm bg-gray-100" readonly>
                </div>
            </div>
            
            <!-- Campos especiales para cotizar por peso (inicialmente ocultos) -->
            <div class="material-campos-peso flex-1 grid grid-cols-3 gap-2" style="display: none;">
                <div>
                    <label class="block text-xs mb-1">¿Cuál es el peso de la estructura? (KG):</label>
                    <input type="number" step="0.01" class="peso-estructura-input w-full p-2 border rounded text-sm" placeholder="Peso en KG">
                </div>
                <div>
                    <label class="block text-xs mb-1">$/Kg:</label>
                    <input type="number" step="0.01" class="precio-kg-input w-full p-2 border rounded text-sm" placeholder="Precio por kilogramo">
                </div>
                <div>
                    <label class="block text-xs mb-1">Subtotal ($):</label>
                    <input type="number" step="0.01" class="subtotal-peso-input w-full p-2 border rounded text-sm bg-green-50" readonly>
                </div>
            </div>
            
            <div class="w-10 flex justify-center">
                <button type="button" onclick="eliminarFila(this, 'material')" class="text-red-500 hover:text-red-700 font-bold text-lg">✕</button>
            </div>
        `;
    } else {
        nuevaFila.className = 'otro-material-row grid grid-cols-12 gap-2 items-end';
        nuevaFila.innerHTML = `
            <div class="col-span-5">
                <label class="block text-xs mb-1">Descripción:</label>
                <input type="text" class="descripcion-otro w-full p-2 border rounded text-sm" placeholder="Descripción del material">
            </div>
            <div class="col-span-2">
                <label class="block text-xs mb-1">Precio ($):</label>
                <input type="number" step="0.01" class="precio-otro w-full p-2 border rounded text-sm">
            </div>
            <div class="col-span-2">
                <label class="block text-xs mb-1">Cantidad:</label>
                <input type="number" step="0.01" class="cantidad-otro w-full p-2 border rounded text-sm">
            </div>
            <div class="col-span-2">
                <label class="block text-xs mb-1">Subtotal ($):</label>
                <input type="number" step="0.01" class="subtotal-otro w-full p-2 border rounded text-sm bg-gray-100" readonly>
            </div>
            <div class="col-span-1 flex justify-center">
                <button type="button" onclick="eliminarFila(this, 'otro')" class="text-red-500 hover:text-red-700 font-bold text-lg">✕</button>
            </div>
        `;
    }
    
    container.appendChild(nuevaFila);
}

function eliminarFila(button, tipo) {
    if (!button) return;
    const fila = button.parentElement.parentElement;
    const itemElement = button.closest('.item-block');
    if (fila) fila.remove();
    if (itemElement) {
        setTimeout(() => {
            calcularCostosItem(itemElement);
            actualizarTodosLosCalculos();
        }, 10);
    }
}

// Factores de conversión de unidades a metros
const FACTORES_CONVERSION = {
    // Lineales (a metros)
    'metros': 1,
    'centimetros': 0.01,
    'pulgadas': 0.0254,
    
    // Área (a metros cuadrados)
    'metros_cuadrados': 1,
    'centimetros_cuadrados': 0.0001,
    'pulgadas_cuadradas': 0.00064516
};

// Función para determinar si un material es lineal (kg/m) o área (kg/m²)
function estipoArea(materialSelect) {
    if (!materialSelect) return false;
    
    const selectedOption = materialSelect.selectedOptions[0];
    if (!selectedOption) return false;
    
    const uom = selectedOption.getAttribute('data-uom');
    return uom && uom.includes('metro cuadrado');
}

// Función para aplicar conversión según el tipo de material y unidad seleccionada
function aplicarConversionUnidad(cantidad, unidadSeleccionada, materialSelect) {
    if (!unidadSeleccionada || !materialSelect) return cantidad;
    
    const factor = FACTORES_CONVERSION[unidadSeleccionada];
    if (!factor) return cantidad;
    
    // Determinar si el material requiere conversión de área o lineal
    const requiereArea = estipoArea(materialSelect);
    const unidadEsArea = unidadSeleccionada.includes('cuadrados') || unidadSeleccionada.includes('cuadradas');
    
    // Solo aplicar conversión si hay compatibilidad entre unidad y tipo de material
    if (requiereArea && unidadEsArea) {
        // Material de área (kg/m²) con unidad de área
        return cantidad * factor;
    } else if (!requiereArea && !unidadEsArea) {
        // Material lineal (kg/m) con unidad lineal  
        return cantidad * factor;
    } else {
        // Incompatibilidad: material lineal con unidad de área o viceversa
        // En este caso, usamos metros como default y mostramos warning
        console.warn(`Incompatibilidad: Material ${requiereArea ? 'de área' : 'lineal'} con unidad ${unidadEsArea ? 'de área' : 'lineal'}`);
        return cantidad * (unidadEsArea ? FACTORES_CONVERSION['metros_cuadrados'] : FACTORES_CONVERSION['metros']);
    }
}

function calcularSubtotalMaterial(input) {
    const row = input.closest('.material-row');
    if (!row) return;
    
    // Buscar campos de forma más flexible
    const pesoInput = row.querySelector('.peso-input') || row.querySelector('input[placeholder*="peso"]') || row.querySelector('input[placeholder*="Peso"]');
    const cantidadInput = row.querySelector('.cantidad-input') || row.querySelector('input[placeholder*="cantidad"]') || row.querySelector('input[placeholder*="Cantidad"]');
    const unidadSelect = row.querySelector('.unidad-select'); // NUEVO: Campo de unidad
    const materialSelect = row.querySelector('.material-select'); // NUEVO: Para determinar tipo de material
    const precioInput = row.querySelector('.precio-input') || row.querySelector('input[placeholder*="precio"]') || row.querySelector('input[placeholder*="Precio"]');
    const subtotalInput = row.querySelector('.subtotal-input') || row.querySelector('input[placeholder*="subtotal"]') || row.querySelector('input[placeholder*="Subtotal"]');
    
    // Obtener valores con mejor manejo de casos edge
    let peso = 1; // Default peso = 1 si no existe campo peso
    let cantidadOriginal = 0;
    let precio = 0;
    
    if (pesoInput) {
        const pesoValue = parseFloat(pesoInput.value);
        // CRÍTICO: Si peso es 0 o NaN, usar 1 como default para materiales válidos
        peso = (isNaN(pesoValue) || pesoValue <= 0) ? 1 : pesoValue;
    }
    
    if (cantidadInput) {
        cantidadOriginal = parseFloat(cantidadInput.value) || 0;
    }
    
    if (precioInput) {
        precio = parseFloat(precioInput.value) || 0;
    }
    
    // NUEVO: Aplicar conversión de unidades
    let cantidadConvertida = cantidadOriginal;
    if (unidadSelect && materialSelect) {
        const unidadSeleccionada = unidadSelect.value;
        cantidadConvertida = aplicarConversionUnidad(cantidadOriginal, unidadSeleccionada, materialSelect);
    }
    
    // FIJO: Calcular subtotal con cantidad convertida: peso * cantidad_convertida * precio
    const subtotal = peso * cantidadConvertida * precio;
    
    // Actualizar campo de subtotal
    if (subtotalInput) {
        subtotalInput.value = subtotal.toFixed(2);
    }
    
    // Debug mejorado para identificar problemas
    console.log('Cálculo material:', {
        peso: peso,
        cantidad: cantidad,
        precio: precio,
        subtotal: subtotal,
        formula: `${peso} * ${cantidad} * ${precio} = ${subtotal}`,
        campos: {
            tienePeso: !!pesoInput,
            tieneCantidad: !!cantidadInput,
            tienePrecio: !!precioInput,
            tieneSubtotal: !!subtotalInput
        },
        valores_originales: {
            peso_input: pesoInput?.value,
            cantidad_input: cantidadInput?.value,
            precio_input: precioInput?.value
        },
        es_revision: !!DATOS_PRECARGADOS
    });
    
    // Recalcular totales del item
    const itemElement = row.closest('.item-block');
    if (itemElement) {
        setTimeout(() => {
            calcularCostosItem(itemElement);
            actualizarTodosLosCalculos();
        }, 10);
    }
}

function calcularSubtotalOtro(input) {
    const row = input.closest('.otro-material-row');
    if (!row) return;
    
    // Buscar campos de forma más flexible
    const precioInput = row.querySelector('.precio-otro') || row.querySelector('input[placeholder*="precio"]') || row.querySelector('input[placeholder*="Precio"]');
    const cantidadInput = row.querySelector('.cantidad-otro') || row.querySelector('input[placeholder*="cantidad"]') || row.querySelector('input[placeholder*="Cantidad"]');
    const subtotalInput = row.querySelector('.subtotal-otro') || row.querySelector('input[placeholder*="subtotal"]') || row.querySelector('input[placeholder*="Subtotal"]');
    
    // Obtener valores
    const precio = parseFloat(precioInput?.value || 0);
    const cantidad = parseFloat(cantidadInput?.value || 0);
    const subtotal = precio * cantidad;
    
    // Actualizar campo de subtotal
    if (subtotalInput) {
        subtotalInput.value = subtotal.toFixed(2);
    }
    
    // Debug para identificar problemas
    console.log('Cálculo otro material:', {
        precio: precio,
        cantidad: cantidad,
        subtotal: subtotal,
        tienePrecio: !!precioInput,
        tieneCantidad: !!cantidadInput,
        tieneSubtotal: !!subtotalInput
    });
    
    // Recalcular totales del item
    const itemElement = row.closest('.item-block');
    if (itemElement) {
        setTimeout(() => {
            calcularCostosItem(itemElement);
            actualizarTodosLosCalculos();
        }, 10);
    }
}

// Nueva función para toggle entre modo normal y cotizar por peso
function toggleCotizarPorPeso(materialRow, mostrarCamposPeso) {
    const camposNormales = materialRow.querySelector('.material-campos-normales');
    const camposPeso = materialRow.querySelector('.material-campos-peso');
    
    if (mostrarCamposPeso) {
        // Mostrar campos de cotizar por peso
        camposNormales.style.display = 'none';
        camposPeso.style.display = 'grid';
        
        // Limpiar campos normales
        materialRow.querySelectorAll('.peso-input, .cantidad-input, .precio-input, .subtotal-input').forEach(input => {
            input.value = '';
        });
    } else {
        // Mostrar campos normales
        camposNormales.style.display = 'grid';
        camposPeso.style.display = 'none';
        
        // Limpiar campos de peso
        materialRow.querySelectorAll('.peso-estructura-input, .precio-kg-input, .subtotal-peso-input').forEach(input => {
            input.value = '';
        });
    }
}

// Función auxiliar para detectar si es cotización por peso
function esCotizacionPorPeso(material) {
    return material === 'COTIZAR_POR_PESO' || 
           (typeof material === 'object' && material.tipoCotizacion === 'peso') ||
           (typeof material === 'object' && material.material === 'COTIZAR_POR_PESO');
}

// Nueva función para calcular subtotal por peso
function calcularSubtotalPeso(input) {
    const row = input.closest('.material-row');
    if (!row) return;
    
    const pesoEstructuraInput = row.querySelector('.peso-estructura-input');
    const precioKgInput = row.querySelector('.precio-kg-input');
    const subtotalPesoInput = row.querySelector('.subtotal-peso-input');
    
    // Obtener valores y validar
    const pesoEstructura = parseFloat(pesoEstructuraInput?.value || 0);
    const precioKg = parseFloat(precioKgInput?.value || 0);
    
    // SEGURIDAD: Validar inputs
    if (pesoEstructura < 0 || pesoEstructura > 100000) {
        console.warn('Peso de estructura inválido:', pesoEstructura);
        return;
    }
    if (precioKg < 0 || precioKg > 10000) {
        console.warn('Precio por KG inválido:', precioKg);
        return;
    }
    
    const subtotal = pesoEstructura * precioKg;
    
    // Actualizar campo de subtotal
    if (subtotalPesoInput) {
        subtotalPesoInput.value = subtotal.toFixed(2);
    }
    
    // Log simplificado para debugging
    console.log('Cálculo cotizar por peso completado');
    
    // Recalcular totales del item
    const itemElement = row.closest('.item-block');
    if (itemElement) {
        setTimeout(() => {
            calcularCostosItem(itemElement);
            actualizarTodosLosCalculos();
        }, 10);
    }
}

function calcularCostosItem(itemElement) {
    if (!itemElement) return;
    let totalMateriales = 0;
    
    // Sumar subtotales de materiales normales
    itemElement.querySelectorAll('.subtotal-input').forEach(input => {
        totalMateriales += parseFloat(input.value || 0);
    });
    
    // Sumar subtotales de cotizar por peso
    itemElement.querySelectorAll('.subtotal-peso-input').forEach(input => {
        totalMateriales += parseFloat(input.value || 0);
    });
    
    let totalOtros = 0;
    itemElement.querySelectorAll('.subtotal-otro').forEach(input => {
        totalOtros += parseFloat(input.value || 0);
    });
    const transporte = parseFloat(itemElement.querySelector('.transporte')?.value || 0);
    const instalacion = parseFloat(itemElement.querySelector('.instalacion')?.value || 0);
    const subtotalBase = totalMateriales + totalOtros + transporte + instalacion;
    const seguridad = parseFloat(itemElement.querySelector('.seguridad')?.value || 0);
    const descuento = parseFloat(itemElement.querySelector('.descuento')?.value || 0);
    const aumentoSeguridad = subtotalBase * (seguridad / 100);
    const subtotalConSeguridad = subtotalBase + aumentoSeguridad;
    const reduccionDescuento = subtotalConSeguridad * (descuento / 100);
    const costoUnidad = subtotalConSeguridad - reduccionDescuento;
    const cantidad = parseFloat(itemElement.querySelector('.cantidad-item')?.value || 1);
    const totalItem = costoUnidad * cantidad;
    const costoUnidadInput = itemElement.querySelector('.costo-unidad');
    const totalItemInput = itemElement.querySelector('.total-item');
    if (costoUnidadInput) costoUnidadInput.value = costoUnidad.toFixed(2);
    if (totalItemInput) totalItemInput.value = totalItem.toFixed(2);
}

function actualizarTodosLosCalculos() {
    let subtotalGeneral = 0;
    const resumenContainer = document.getElementById('resumen-items');
    resumenContainer.innerHTML = '';
    document.querySelectorAll('.item-block').forEach((item, index) => {
        calcularCostosItem(item);
        const descripcion = item.querySelector('.descripcion-item')?.value?.trim() || `Item ${index + 1}`;
        const totalItem = parseFloat(item.querySelector('.total-item')?.value || 0);
        const cantidad = parseFloat(item.querySelector('.cantidad-item')?.value || 0);
        const uom = item.querySelector('.uom-item')?.value || 'Pieza';
        subtotalGeneral += totalItem;
        if (totalItem > 0 || descripcion !== `Item ${index + 1}`) {
            const itemResumen = document.createElement('div');
            itemResumen.className = 'bg-white p-3 rounded-lg shadow border-l-4 border-blue-500 mb-2';
            
            // Esta secci\u00f3n se actualizar\u00e1 despu\u00e9s con la conversi\u00f3n USD si aplica
            itemResumen.innerHTML = `
                <div class="flex justify-between items-center">
                    <div>
                        <h4 class="font-semibold text-gray-800">${descripcion}</h4>
                        <p class="text-sm text-gray-600">${cantidad} ${uom} \u00d7 $${(totalItem/cantidad || 0).toFixed(2)} c/u</p>
                    </div>
                    <div class="text-right">
                        <p class="text-lg font-bold text-blue-600 item-total-display">$${totalItem.toFixed(2)}</p>
                    </div>
                </div>
            `;
            resumenContainer.appendChild(itemResumen);
        }
    });
    // Calcular IVA y gran total
    const iva = subtotalGeneral * 0.16;
    const granTotal = subtotalGeneral + iva;
    
    // Verificar si la moneda es USD para aplicar conversión
    const monedaSelect = document.getElementById('moneda');
    const tipoCambioInput = document.getElementById('tipo-cambio');
    const esUSD = monedaSelect?.value === 'USD';
    const tipoCambio = parseFloat(tipoCambioInput?.value || 1);
    
    // SEGURIDAD: Validar tipo de cambio
    if (esUSD && (tipoCambio <= 0 || tipoCambio > 1000 || isNaN(tipoCambio))) {
        console.warn('Tipo de cambio inválido:', tipoCambio);
        return; // No aplicar conversión con valores inválidos
    }
    
    let subtotalMostrar = subtotalGeneral;
    let ivaMostrar = iva;
    let granTotalMostrar = granTotal;
    let simboloMoneda = '$';
    
    if (esUSD && tipoCambio > 0) {
        // Convertir a USD dividiendo entre el tipo de cambio
        subtotalMostrar = subtotalGeneral / tipoCambio;
        ivaMostrar = iva / tipoCambio;
        granTotalMostrar = granTotal / tipoCambio;
        simboloMoneda = 'USD $';
        
        // Log simplificado (sin datos financieros sensibles)
        console.log('Conversión USD aplicada con tipo de cambio:', tipoCambio);
    }
    
    // Actualizar elementos en pantalla
    const subtotalElement = document.getElementById('subtotal-items');
    const ivaElement = document.getElementById('iva-total');
    const granTotalElement = document.getElementById('gran-total');
    
    if (subtotalElement) subtotalElement.textContent = `${simboloMoneda}${subtotalMostrar.toFixed(2)}`;
    if (ivaElement) ivaElement.textContent = `${simboloMoneda}${ivaMostrar.toFixed(2)}`;
    if (granTotalElement) granTotalElement.textContent = `${simboloMoneda}${granTotalMostrar.toFixed(2)}`;
    
    // Actualizar totales de items individuales en el resumen si es USD
    if (esUSD && tipoCambio > 0 && tipoCambio != 1.0) {
        // Actualizar también los precios por unidad y totales en el resumen
        const itemBlocks = document.querySelectorAll('.item-block');
        const resumenContainer = document.getElementById('resumen-items');
        
        // Recrear el resumen con precios en USD
        if (resumenContainer) {
            // Limpiar y recrear elementos del resumen con conversión USD
            resumenContainer.innerHTML = '';
            
            itemBlocks.forEach((item, index) => {
                const descripcion = item.querySelector('.descripcion-item')?.value?.trim() || `Item ${index + 1}`;
                const totalItemMXN = parseFloat(item.querySelector('.total-item')?.value || 0);
                const cantidad = parseFloat(item.querySelector('.cantidad-item')?.value || 0);
                const uom = item.querySelector('.uom-item')?.value || 'Pieza';
                
                if (totalItemMXN > 0 || descripcion !== `Item ${index + 1}`) {
                    // Convertir a USD
                    const totalItemUSD = totalItemMXN / tipoCambio;
                    const precioUnitarioUSD = cantidad > 0 ? totalItemUSD / cantidad : 0;
                    
                    const itemResumen = document.createElement('div');
                    itemResumen.className = 'bg-white p-3 rounded-lg shadow border-l-4 border-blue-500 mb-2';
                    itemResumen.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <h4 class="font-semibold text-gray-800">${descripcion}</h4>
                                <p class="text-sm text-gray-600">${cantidad} ${uom} × USD $${precioUnitarioUSD.toFixed(2)} c/u</p>
                            </div>
                            <div class="text-right">
                                <p class="text-lg font-bold text-blue-600">USD $${totalItemUSD.toFixed(2)}</p>
                            </div>
                        </div>
                    `;
                    resumenContainer.appendChild(itemResumen);
                }
            });
        }
    }
}

function toggleTipoCambio() {
    const moneda = document.getElementById('moneda')?.value;
    const container = document.getElementById('tipo-cambio-container');
    const tipoCambioInput = document.getElementById('tipo-cambio');
    if (moneda === 'USD') {
        container.style.display = 'block';
        tipoCambioInput.required = true;
    } else {
        container.style.display = 'none';
        tipoCambioInput.required = false;
        tipoCambioInput.value = '';
    }
    
    // Recalcular todos los totales cuando cambia la moneda
    setTimeout(() => {
        actualizarTodosLosCalculos();
    }, 100);
}

async function guardarCotizacion() {
    const btnGuardar = document.getElementById('btn-guardar');
    const textoOriginal = btnGuardar.innerHTML;
    btnGuardar.disabled = true;
    btnGuardar.classList.add('btn-loading');
    btnGuardar.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 6v3l4-4-4-4v3c-4.42 0-8 3.58-8 8 0 1.57.46 3.03 1.24 4.26L6.7 14.8c-.45-.83-.7-1.79-.7-2.8 0-3.31 2.69-6 6-6zm6.76 1.74L17.3 9.2c.44.84.7 1.79.7 2.8 0 3.31-2.69 6-6 6v-3l-4 4 4 4v-3c4.42 0 8-3.58 8-8 0-1.57-.46-3.03-1.24-4.26z"/></svg> Guardando...';
    
    try {
        const camposRequeridos = ['vendedor', 'proyecto', 'cliente', 'atencionA', 'contacto'];
        for (let campo of camposRequeridos) {
            const elemento = document.querySelector(`[name="${campo}"]`);
            if (!elemento || !elemento.value.trim()) {
                alert(`El campo "${campo}" es obligatorio.`);
                elemento?.focus();
                return;
            }
        }

        // VALIDACIÓN OBLIGATORIA: Justificación de actualización para revisiones >= 2
        const revision = parseInt(document.querySelector('[name="revision"]')?.value || 1);
        if (revision >= 2) {
            const actualizacionTextarea = document.querySelector('[name="actualizacionRevision"]');
            const actualizacion = actualizacionTextarea?.value?.trim();
            if (!actualizacion || actualizacion.length < 10) {
                // Resaltar el campo con error
                actualizacionTextarea.style.borderColor = '#dc2626';
                actualizacionTextarea.style.boxShadow = '0 0 0 3px rgba(220, 38, 38, 0.1)';
                
                // Mostrar mensaje de error más informativo
                const errorMsg = actualizacion ? 
                    'La justificación debe tener al menos 10 caracteres para explicar los cambios realizados.' :
                    'Debe proporcionar una justificación detallada para revisiones R2 o superiores.';
                
                alert(errorMsg);
                actualizacionTextarea?.focus();
                
                // Remover el estilo de error después de 3 segundos
                setTimeout(() => {
                    actualizacionTextarea.style.borderColor = '';
                    actualizacionTextarea.style.boxShadow = '';
                }, 3000);
                
                return;
            }
        }

        // VALIDACIÓN: Verificar que se hayan hecho cambios en revisiones
        if (estadoInicialFormulario !== null) {
            const hayCambios = formularioTieneCambios();

            if (!hayCambios) {
                alert('No se han detectado cambios en el formulario.\n\nDebe realizar al menos una modificación (en items, cantidades, precios, términos, etc.) antes de guardar la revisión.');

                btnGuardar.disabled = false;
                btnGuardar.classList.remove('btn-loading');
                btnGuardar.innerHTML = textoOriginal;

                console.log('[DETECCION_CAMBIOS] Guardado cancelado: No hay cambios');
                return;
            } else {
                console.log('[DETECCION_CAMBIOS] Cambios detectados, procediendo con guardado');
            }
        }

        const datosGenerales = {};
        const campos = ['vendedor', 'proyecto', 'cliente', 'atencionA', 'contacto', 'revision'];
        campos.forEach(campo => {
            const elemento = document.querySelector(`[name="${campo}"]`);
            if (elemento) {
                datosGenerales[campo] = elemento.value.trim();
            }
        });

        const actualizacionElement = document.querySelector('[name="actualizacionRevision"]');
        if (actualizacionElement && actualizacionElement.value.trim()) {
            datosGenerales.actualizacionRevision = actualizacionElement.value.trim();
        }

        const items = [];
        const itemsBlocks = document.querySelectorAll('.item-block');
        
        if (itemsBlocks.length === 0) {
            alert('Debe agregar al menos un item a la cotización.');
            return;
        }

        itemsBlocks.forEach((item, index) => {
            const descripcion = item.querySelector('.descripcion-item')?.value?.trim() || "";
            const cantidad = item.querySelector('.cantidad-item')?.value || "0";
            const uom = item.querySelector('.uom-item')?.value || "Pieza";
            const costoUnidad = item.querySelector('.costo-unidad')?.value || "0";
            const totalItem = item.querySelector('.total-item')?.value || "0";
            const transporte = item.querySelector('.transporte')?.value || "0";
            const instalacion = item.querySelector('.instalacion')?.value || "0";
            const seguridad = item.querySelector('.seguridad')?.value || "0";
            const descuento = item.querySelector('.descuento')?.value || "0";

            const materiales = [];
            item.querySelectorAll('.materiales-container .material-row').forEach(row => {
                const material = row.querySelector('.material-select')?.value;
                
                if (material && material.trim() !== "") {
                    if (esCotizacionPorPeso(material)) {
                        // Campos especiales para cotizar por peso
                        const pesoEstructura = row.querySelector('.peso-estructura-input')?.value || "0";
                        const precioKg = row.querySelector('.precio-kg-input')?.value || "0";
                        const subtotalPeso = row.querySelector('.subtotal-peso-input')?.value || "0";
                        
                        materiales.push({
                            material: 'COTIZAR_POR_PESO',
                            pesoEstructura: pesoEstructura,
                            precioKg: precioKg,
                            subtotal: subtotalPeso,
                            tipoCotizacion: 'peso'
                        });
                    } else {
                        // Campos normales para materiales estándar
                        const peso = row.querySelector('.peso-input')?.value || "0";
                        const cantidadMat = row.querySelector('.cantidad-input')?.value || "0";
                        const precio = row.querySelector('.precio-input')?.value || "0";
                        const subtotal = row.querySelector('.subtotal-input')?.value || "0";
                        
                        materiales.push({
                            material: material,
                            peso: peso,
                            cantidad: cantidadMat,
                            precio: precio,
                            subtotal: subtotal,
                            tipoCotizacion: 'normal'
                        });
                    }
                }
            });

            const otrosMateriales = [];
            item.querySelectorAll('.otros-materiales-container .otro-material-row').forEach(row => {
                const descripcionOtro = row.querySelector('.descripcion-otro')?.value?.trim();
                const precioOtro = row.querySelector('.precio-otro')?.value || "0";
                const cantidadOtro = row.querySelector('.cantidad-otro')?.value || "0";
                const subtotalOtro = row.querySelector('.subtotal-otro')?.value || "0";
                
                if (descripcionOtro && descripcionOtro !== "") {
                    otrosMateriales.push({
                        descripcion: descripcionOtro,
                        precio: precioOtro,
                        cantidad: cantidadOtro,
                        subtotal: subtotalOtro
                    });
                }
            });

            if (descripcion !== "" || materiales.length > 0 || otrosMateriales.length > 0) {
                items.push({
                    descripcion: descripcion,
                    cantidad: cantidad,
                    uom: uom,
                    costoUnidad: costoUnidad,
                    total: totalItem,
                    transporte: transporte,
                    instalacion: instalacion,
                    seguridad: seguridad,
                    descuento: descuento,
                    materiales: materiales,
                    otrosMateriales: otrosMateriales
                });
            }
        });

        if (items.length === 0) {
            alert('Debe completar al menos un item con información válida.');
            return;
        }

        const condiciones = {
            moneda: document.querySelector('select[name="moneda"]')?.value || "",
            tipoCambio: document.querySelector('input[name="tipoCambio"]')?.value || "",
            tiempoEntrega: document.querySelector('input[name="tiempoEntrega"]')?.value || "",
            entregaEn: document.querySelector('input[name="entregaEn"]')?.value || "",
            terminos: document.querySelector('input[name="terminos"]')?.value || "",
            comentarios: document.querySelector('textarea[name="comentarios"]')?.value || ""
        };

        // Solo moneda es obligatoria - otros campos opcionales para flexibilidad USD
        if (!condiciones.moneda || condiciones.moneda.trim() === "") {
            alert('El campo "moneda" en Términos y Condiciones es obligatorio.');
            document.querySelector('[name="moneda"]')?.focus();
            return;
        }

        if (condiciones.moneda === 'USD' && (!condiciones.tipoCambio || parseFloat(condiciones.tipoCambio) <= 0)) {
            alert('El tipo de cambio es obligatorio para USD y debe ser mayor a 0.');
            document.getElementById('tipo-cambio')?.focus();
            return;
        }

        // FIX ISSUE #1: Incluir numeroCotizacionHidden para revisiones
        const numeroHidden = document.querySelector('[name="numeroCotizacionHidden"]')?.value?.trim();
        
        const datosCompletos = {
            datosGenerales: datosGenerales,
            items: items,
            condiciones: condiciones,
            // Agregar campos de numeración que espera el servidor
            numeroCotizacionHidden: numeroHidden || datosGenerales.numeroCotizacion,
            numeroCotizacion: datosGenerales.numeroCotizacion
        };
        
        // Debug para Issue #1
        console.log('[ISSUE1_DEBUG] Enviando al servidor:');
        console.log('[ISSUE1_DEBUG] numeroCotizacionHidden:', datosCompletos.numeroCotizacionHidden);
        console.log('[ISSUE1_DEBUG] numeroCotizacion:', datosCompletos.numeroCotizacion);
        console.log('[ISSUE1_DEBUG] datosGenerales.numeroCotizacion:', datosCompletos.datosGenerales.numeroCotizacion);

        const respuesta = await fetch("/formulario", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Accept": "application/json"
            },
            body: JSON.stringify(datosCompletos)
        });

        if (!respuesta.ok) {
            throw new Error(`Error HTTP ${respuesta.status}: ${respuesta.statusText}`);
        }

        const resultado = await respuesta.json();
        
        if (resultado.success || resultado.mensaje) {
            // Actualizar el campo No. Cotización con el número generado automáticamente
            const numeroGenerado = resultado.numeroCotizacion;
            console.log('Número generado recibido:', numeroGenerado);
            
            if (numeroGenerado) {
                // Actualizar campo visible (disabled)
                const campoNumeroCotizacion = document.querySelector('[name="numeroCotizacion"]');
                console.log('Campo encontrado:', campoNumeroCotizacion);
                
                if (campoNumeroCotizacion) {
                    // Habilitar temporalmente para actualizar
                    campoNumeroCotizacion.removeAttribute('disabled');
                    campoNumeroCotizacion.value = numeroGenerado;
                    // Volver a deshabilitar
                    campoNumeroCotizacion.setAttribute('disabled', 'disabled');
                    console.log('Campo visible actualizado con:', numeroGenerado);
                }
                
                // Actualizar campo hidden para envío del formulario
                const campoHidden = document.querySelector('[name="numeroCotizacionHidden"]');
                if (campoHidden) {
                    campoHidden.value = numeroGenerado;
                    console.log('Campo hidden actualizado con:', numeroGenerado);
                }
                
                // Guardar en variables auxiliares para uso posterior (como PDF)
                window.ultimoNumeroCotizacion = numeroGenerado;
                sessionStorage.setItem('ultimoNumeroCotizacion', numeroGenerado);
            }
            
            const mensaje = `¡Cotización guardada exitosamente!\n\nNúmero: ${numeroGenerado || datosGenerales.numeroCotizacion}\nRevisión: ${datosGenerales.revision}\nID: ${resultado.id || 'Generado automáticamente'}\nCliente: ${datosGenerales.cliente}\nVendedor: ${datosGenerales.vendedor}\nItems procesados: ${items.length}\nTotal: ${document.getElementById('gran-total')?.textContent || 'N/A'}`;
            
            alert(mensaje);
            cotizacionGuardada = true;
            
            const botonGenerar = document.getElementById("btn-generar");
            if (botonGenerar) {
                botonGenerar.disabled = false;
                botonGenerar.classList.remove("bg-gray-400", "cursor-not-allowed");
                botonGenerar.classList.add("bg-green-600", "hover:bg-green-700");
                botonGenerar.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg> PDF';
            }
            
            btnGuardar.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M9,20.42L2.79,14.21L5.62,11.38L9,14.77L18.88,4.88L21.71,7.71L9,20.42Z"/></svg> Guardado';
            btnGuardar.classList.remove("bg-blue-600", "hover:bg-blue-700");
            btnGuardar.classList.add("bg-green-600");
            
        } else {
            const errorMensaje = resultado.error || resultado.detalle || "Error desconocido del servidor";
            
            // Manejo específico para errores de validación de justificación
            if (resultado.campo_requerido === 'actualizacionRevision') {
                const actualizacionTextarea = document.querySelector('[name="actualizacionRevision"]');
                if (actualizacionTextarea) {
                    // Resaltar el campo con error
                    actualizacionTextarea.style.borderColor = '#dc2626';
                    actualizacionTextarea.style.boxShadow = '0 0 0 3px rgba(220, 38, 38, 0.1)';
                    actualizacionTextarea.focus();
                    
                    // Remover el estilo de error después de 5 segundos
                    setTimeout(() => {
                        actualizacionTextarea.style.borderColor = '';
                        actualizacionTextarea.style.boxShadow = '';
                    }, 5000);
                }
            }
            
            alert(`Error al guardar la cotización:\n\n${errorMensaje}\n\nPor favor, verifica los datos e intenta nuevamente.`);
            throw new Error(errorMensaje);
        }

    } catch (error) {
        let mensajeError = "Error inesperado al guardar la cotización:\n\n";
        
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
            mensajeError += "Problema de conexión con el servidor. Verifica tu conexión a internet.";
        } else if (error.message.includes('JSON')) {
            mensajeError += "Error al procesar la respuesta del servidor.";
        } else {
            mensajeError += error.message;
        }
        
        alert(`${mensajeError}\n\nIntenta nuevamente o contacta al administrador del sistema.`);
        cotizacionGuardada = false;
    } finally {
        if (!cotizacionGuardada) {
            btnGuardar.disabled = false;
            btnGuardar.classList.remove('btn-loading');
            btnGuardar.innerHTML = textoOriginal;
        }
    }
}

async function intentarGenerarCotizacion() {
    if (!cotizacionGuardada) {
        alert("Primero debes guardar la cotización antes de generar el PDF.\n\nHaz clic en 'Guardar Cotización' para continuar.");
        return;
    }
    
    // Intentar obtener el número de varias fuentes con debug
    let numeroCotizacion = document.querySelector('[name="numeroCotizacion"]')?.value?.trim();
    console.log('Campo visible:', numeroCotizacion);
    
    // Si el campo visible está vacío (por estar disabled), intentar el campo hidden
    if (!numeroCotizacion) {
        numeroCotizacion = document.querySelector('[name="numeroCotizacionHidden"]')?.value?.trim();
        console.log('Campo hidden:', numeroCotizacion);
    }
    
    // Si aún no hay número, intentar obtenerlo de variables auxiliares
    if (!numeroCotizacion) {
        numeroCotizacion = window.ultimoNumeroCotizacion || sessionStorage.getItem('ultimoNumeroCotizacion');
        console.log('Variables auxiliares:', numeroCotizacion);
    }
    
    if (!numeroCotizacion) {
        alert('No se encontró el número de cotización. Asegúrate de que la cotización esté guardada correctamente.\n\nVerifica la consola del navegador (F12) para más detalles.');
        return;
    }
    
    console.log('Numero final para PDF:', numeroCotizacion);
    
    const btnGenerar = document.getElementById('btn-generar');
    const textoOriginal = btnGenerar.innerHTML;
    
    try {
        btnGenerar.disabled = true;
        btnGenerar.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 6v3l4-4-4-4v3c-4.42 0-8 3.58-8 8 0 1.57.46 3.03 1.24 4.26L6.7 14.8c-.45-.83-.7-1.79-.7-2.8 0-3.31 2.69-6 6-6zm6.76 1.74L17.3 9.2c.44.84.7 1.79.7 2.8 0 3.31-2.69 6-6 6v-3l-4 4 4 4v-3c4.42 0 8-3.58 8-8 0-1.57-.46-3.03-1.24-4.26z"/></svg> Generando PDF...';
        
        const response = await fetch('/generar_pdf', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                numeroCotizacion: numeroCotizacion
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            console.error('Error del servidor PDF:', errorData);
            console.error('Status:', response.status);
            console.error('StatusText:', response.statusText);
            
            let errorMsg = errorData.error || errorData.detalle || `Error HTTP ${response.status}`;
            if (errorData.mensaje) {
                errorMsg += '\n' + errorData.mensaje;
            }
            throw new Error(errorMsg);
        }
        
        const pdfBlob = await response.blob();
        const pdfUrl = window.URL.createObjectURL(pdfBlob);
        const downloadLink = document.createElement('a');
        downloadLink.href = pdfUrl;
        downloadLink.download = `Cotizacion_${numeroCotizacion.replace('/', '_')}.pdf`;
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
        window.URL.revokeObjectURL(pdfUrl);
        
        alert(`PDF generado exitosamente para la cotización ${numeroCotizacion}\n\nEl archivo se ha descargado automáticamente.`);
        
        btnGenerar.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M9,20.42L2.79,14.21L5.62,11.38L9,14.77L18.88,4.88L21.71,7.71L9,20.42Z"/></svg> PDF Generado';
        btnGenerar.classList.remove('bg-green-600', 'hover:bg-green-700');
        btnGenerar.classList.add('bg-blue-600');
        
    } catch (error) {
        let mensajeError = 'Error al generar el PDF:\n\n';
        
        if (error.message.includes('WeasyPrint no está instalado')) {
            mensajeError += 'WeasyPrint no está instalado en el servidor.\n\nPara habilitar la generación de PDF:\n1. Ejecuta: pip install weasyprint\n2. Reinicia el servidor\n3. Consulta INSTRUCCIONES_PDF.md para más detalles';
        } else if (error.message.includes('weasyprint')) {
            mensajeError += 'El servidor no tiene WeasyPrint instalado. Contacta al administrador para instalar las dependencias necesarias.';
        } else if (error.message.includes('no encontrada')) {
            mensajeError += 'La cotización no fue encontrada en la base de datos. Asegúrate de que esté guardada correctamente.';
        } else {
            mensajeError += error.message;
        }
        
        alert(`${mensajeError}\n\nIntenta nuevamente o contacta al soporte técnico.`);
        
    } finally {
        if (btnGenerar.innerHTML.includes('Generando')) {
            btnGenerar.disabled = false;
            btnGenerar.innerHTML = textoOriginal;
        }
    }
}
</script>

</body>
</html>