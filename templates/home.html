<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CWS - Cotizaciones</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #2c2c2c;
        }
        
        .container {
            background: #ffffff;
            padding: 48px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
            width: 100%;
            max-width: 600px;
            text-align: center;
            border: 1px solid #e9ecef;
        }
        
        .logo {
            margin-bottom: 16px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .logo img {
            max-height: 80px;
            max-width: 200px;
            object-fit: contain;
        }
        
        h1 {
            color: #212529;
            margin-bottom: 48px;
            font-weight: 400;
            font-size: 24px;
            letter-spacing: -0.5px;
        }
        
        .search-container {
            position: relative;
            margin-bottom: 32px;
        }
        
        .search-input {
            width: 100%;
            padding: 16px 20px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            transition: all 0.2s ease;
            background: #ffffff;
            box-shadow: none;
        }
        
        .search-input:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .search-input::placeholder {
            color: #6c757d;
        }
        
        .button-group {
            display: flex;
            gap: 16px;
            justify-content: center;
            align-items: center;
        }
        
        .icon-button {
            width: 48px;
            height: 48px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.2s ease;
            position: relative;
            background: #ffffff;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-search {
            background: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }
        
        .btn-all {
            background: #6366f1;
            color: white;
            border-color: #6366f1;
        }
        
        .btn-new {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }
        
        .icon-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .icon-button:active {
            transform: translateY(0);
        }
        
        .icon-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .tooltip {
            position: absolute;
            bottom: -32px;
            left: 50%;
            transform: translateX(-50%);
            background: #212529;
            color: white;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 11px;
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
            white-space: nowrap;
        }
        
        .icon-button:hover .tooltip {
            opacity: 1;
        }
        
        .results-container {
            margin-top: 32px;
            text-align: left;
        }
        
        .result-item {
            background: #ffffff;
            border: 1px solid #e9ecef;
            padding: 16px;
            margin: 8px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .result-item:hover {
            background: #f8f9fa;
            border-color: #4f46e5;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .result-field {
            margin: 4px 0;
            display: flex;
            align-items: center;
        }
        
        .result-field strong {
            color: #6c757d;
            margin-right: 8px;
            min-width: 80px;
            font-size: 13px;
            font-weight: 500;
        }
        
        .result-field .value {
            color: #212529;
            font-size: 14px;
        }
        
        .result-meta {
            font-size: 11px;
            color: #adb5bd;
            margin-top: 12px;
            text-align: center;
            padding-top: 8px;
            border-top: 1px solid #e9ecef;
        }
        
        .message {
            text-align: center;
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
            font-size: 14px;
        }
        
        .message.loading {
            background: #f8f9fa;
            color: #6c757d;
            border: 1px solid #e9ecef;
        }
        
        .message.error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        
        .message.success {
            background: #f0fdf4;
            color: #16a34a;
            border: 1px solid #bbf7d0;
        }
        
        .stats {
            text-align: center;
            margin-bottom: 16px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            color: #495057;
            font-weight: 500;
            font-size: 14px;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 30px 20px;
            }
            
            .button-group {
                gap: 15px;
            }
            
            .icon-button {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .logo img {
                max-height: 60px;
                max-width: 150px;
            }
        }
        
        /* Animaci√≥n de carga */
        .btn-search.loading {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        /* Highlight para b√∫squedas */
        mark {
            background-color: #ffeb3b;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: bold;
        }
        
        /* Estilos para tabla de resultados - SIN ALTERAR FUNCIONALIDAD */
        .results-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
            margin-top: 16px;
        }
        
        .results-table thead th {
            background: #f8f9fa;
            color: #495057;
            font-weight: 600;
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
            font-size: 13px;
        }
        
        .results-table tbody tr {
            border-bottom: 1px solid #e9ecef;
            transition: background-color 0.2s ease;
        }
        
        .results-table tbody tr:nth-child(even) {
            background: #fafafa;
        }
        
        .results-table tbody tr:hover {
            background: #e3f2fd;
            cursor: default;
        }
        
        .results-table td {
            padding: 12px;
            vertical-align: middle;
            font-size: 13px;
            color: #495057;
        }
        
        .results-table .numero-column {
            font-weight: bold;
            color: #4f46e5;
            min-width: 120px;
        }
        
        .results-table .tipo-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .results-table .tipo-nueva {
            background: #d1fae5;
            color: #065f46;
        }
        
        .results-table .tipo-historica {
            background: #fef3c7;
            color: #92400e;
        }
        
        .results-table .acciones-column {
            min-width: 140px;
            white-space: nowrap;
        }
        
        .results-table .btn-accion {
            padding: 6px 10px;
            margin: 0 2px;
            font-size: 11px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .results-table .btn-pdf {
            background: #4f46e5;
            color: white;
        }
        
        .results-table .btn-pdf:hover {
            background: #3730a3;
        }
        
        .results-table .btn-desglose {
            background: #10b981;
            color: white;
        }
        
        .results-table .btn-desglose:hover {
            background: #047857;
        }
        
        .results-table .sin-desglose {
            color: #6c757d;
            font-size: 10px;
            font-style: italic;
        }
        
        /* Responsive para mantener compatibilidad m√≥vil */
        @media (max-width: 768px) {
            .results-table {
                font-size: 12px;
            }
            
            .results-table th,
            .results-table td {
                padding: 8px;
            }
            
            .results-table .btn-accion {
                padding: 4px 6px;
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <img src="/static/logo.png" alt="CWS Company">
        </div>
        <h1>CWS Sistema de Cotizaciones</h1>
        
        <div class="search-container">
            <input type="text" 
                   id="searchInput" 
                   class="search-input"
                   placeholder="Buscar por n√∫mero, cliente, vendedor, proyecto...">
        </div>
        
        <div class="button-group">
            <button class="icon-button btn-search" 
                    onclick="buscar()" 
                    id="btnBuscar"
                    title="Buscar cotizaciones">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                </svg>
                <div class="tooltip">Buscar</div>
            </button>
            
            <button class="icon-button btn-all" 
                    onclick="verTodos()"
                    title="Ver todas las cotizaciones">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/>
                </svg>
                <div class="tooltip">Ver Todas</div>
            </button>
            
            <button class="icon-button btn-new" 
                    onclick="nuevaCotizacion()"
                    title="Nueva cotizaci√≥n">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                </svg>
                <div class="tooltip">Nueva Cotizaci√≥n</div>
            </button>
        </div>
        
        <div id="resultados" class="results-container"></div>
    </div>

    <script>
        // Variables globales
        let ultimaBusqueda = '';
        
        // Funci√≥n de b√∫squeda
        function buscar() {
            const query = document.getElementById('searchInput').value.trim();
            // Permitir b√∫squeda vac√≠a para mostrar todos los resultados
            if (!query) {
                console.log('üîç B√∫squeda vac√≠a - mostrando todos los resultados');
            }

            ultimaBusqueda = query;
            const btnBuscar = document.getElementById('btnBuscar');
            btnBuscar.disabled = true;
            btnBuscar.classList.add('loading');
            btnBuscar.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 6v3l4-4-4-4v3c-4.42 0-8 3.58-8 8 0 1.57.46 3.03 1.24 4.26L6.7 14.8c-.45-.83-.7-1.79-.7-2.8 0-3.31 2.69-6 6-6zm6.76 1.74L17.3 9.2c.44.84.7 1.79.7 2.8 0 3.31-2.69 6-6 6v-3l-4 4 4 4v-3c4.42 0 8-3.58 8-8 0-1.57-.46-3.03-1.24-4.26z"/></svg>';
            
            // CORRECCI√ìN: B√∫squeda unificada - usar cotizaciones directamente para evitar inconsistencias
            const mensaje = query ? `Buscando "${query}"...` : 'Cargando todas las cotizaciones...';
            mostrarMensaje(mensaje, 'loading');
            console.log('üîç B√∫squeda unificada iniciada para:', query || '(todos los resultados)');

            fetch('/buscar', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({ query: query })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('‚úÖ Resultados unificados:', data);
                procesarRespuesta({
                    resultados: data.resultados || [],
                    total: data.total || 0,
                    modo: 'unificado'
                });
            })
            .catch(error => {
                console.error('‚ùå Error en b√∫squeda unificada:', error);
                mostrarMensaje(`Error en b√∫squeda: ${error.message}`, 'error');
            })
            .finally(() => {
                btnBuscar.disabled = false;
                btnBuscar.classList.remove('loading');
                btnBuscar.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>';
            });
        }

        // Funci√≥n para procesar respuesta
        function procesarRespuesta(data) {
            if (data.error) {
                mostrarMensaje(`Error: ${data.error}`, 'error');
                return;
            }

            let cotizaciones = [];
            
            if (data.resultados && Array.isArray(data.resultados)) {
                cotizaciones = data.resultados;
            } else if (Array.isArray(data)) {
                cotizaciones = data;
            } else {
                mostrarMensaje('Formato de respuesta no v√°lido', 'error');
                return;
            }

            mostrarResultados(cotizaciones, data.total || cotizaciones.length);
        }

        // Funci√≥n para mostrar resultados de PDFs
        function mostrarResultados(pdfs, total) {
            const div = document.getElementById('resultados');
            
            if (!pdfs || pdfs.length === 0) {
                const mensaje = ultimaBusqueda ? 
                    `No se encontraron resultados para "${ultimaBusqueda}"` : 
                    'No se encontraron resultados en el sistema';
                mostrarMensaje(mensaje, 'error');
                return;
            }

            let html = `
                <div class="stats">
                    <strong>${pdfs.length}</strong> PDF(s) encontrado(s)
                    ${ultimaBusqueda ? `para "<em>${ultimaBusqueda}</em>"` : ''}
                </div>
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>N√∫mero</th>
                            <th>Cliente</th>
                            <th>Vendedor</th>
                            <th>Proyecto</th>
                            <th>Fecha</th>
                            <th>Tipo</th>
                            <th class="acciones-column">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            pdfs.forEach((pdf, index) => {
                // Detectar si es cotizaci√≥n (del fallback) o PDF real - SIN CAMBIOS
                const esCotizacion = pdf._id && !pdf.numero_cotizacion;
                const identificador = esCotizacion ? pdf._id : (pdf.numero_cotizacion || `PDF-${index + 1}`);
                const numeroDisplay = esCotizacion ? (pdf.numeroCotizacion || pdf.datosGenerales?.numeroCotizacion || identificador) : (pdf.numero_cotizacion || `PDF-${index + 1}`);
                const clienteDisplay = esCotizacion ? (pdf.datosGenerales?.cliente || 'Cliente no especificado') : (pdf.cliente || 'Cliente no especificado');
                const vendedorDisplay = esCotizacion ? (pdf.datosGenerales?.vendedor || 'Vendedor no especificado') : (pdf.vendedor || 'Vendedor no especificado');
                const proyectoDisplay = esCotizacion ? (pdf.datosGenerales?.proyecto || 'Proyecto no especificado') : (pdf.proyecto || 'Proyecto no especificado');
                const fechaDisplay = esCotizacion ? (pdf.datosGenerales?.fecha || pdf.fechaCreacion || 'Fecha no especificada') : (pdf.fecha || 'Fecha no especificada');
                const tipoDisplay = pdf.tipo === 'nueva' ? 'Nueva' : 'Hist√≥rica';
                const tieneDesglose = esCotizacion ? true : pdf.tiene_desglose;
                
                // Funci√≥n para resaltar coincidencias - SIN CAMBIOS
                const resaltarTexto = (texto) => {
                    if (!ultimaBusqueda) return texto;
                    const regex = new RegExp(`(${ultimaBusqueda})`, 'gi');
                    return texto.replace(regex, '<mark>$1</mark>');
                };
                
                html += `
                    <tr>
                        <td class="numero-column">${resaltarTexto(numeroDisplay)}</td>
                        <td>${resaltarTexto(clienteDisplay)}</td>
                        <td>${resaltarTexto(vendedorDisplay)}</td>
                        <td>${resaltarTexto(proyectoDisplay)}</td>
                        <td>${fechaDisplay}</td>
                        <td>
                            <span class="tipo-badge ${pdf.tipo === 'nueva' ? 'tipo-nueva' : 'tipo-historica'}">
                                ${tipoDisplay}
                            </span>
                        </td>
                        <td class="acciones-column">
                            <button onclick="verPDF('${numeroDisplay}')" class="btn-accion btn-pdf">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                                </svg>
                                PDF
                            </button>
                            ${tieneDesglose ? `
                            <button onclick="verDesglose('${esCotizacion ? identificador : numeroDisplay}')" class="btn-accion btn-desglose">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M3,3H21V5H3V3M3,7H21V9H3V7M3,11H21V13H3V11M3,15H21V17H3V15M3,19H21V21H3V19Z"/>
                                </svg>
                                Desglose
                            </button>
                            ` : `
                            <span class="sin-desglose">Sin desglose</span>
                            `}
                        </td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            div.innerHTML = html;
        }

        // Funci√≥n para mostrar mensajes
        function mostrarMensaje(texto, tipo = 'loading') {
            const div = document.getElementById('resultados');
            div.innerHTML = `<div class="message ${tipo}">${texto}</div>`;
        }

        // Funci√≥n para ver PDF
        function verPDF(numeroCotizacion) {
            console.log(`Abriendo PDF: ${numeroCotizacion}`);
            const identificadorCodificado = encodeURIComponent(numeroCotizacion);
            window.open(`/pdf/${identificadorCodificado}`, '_blank');
        }

        // Funci√≥n para ver desglose
        function verDesglose(numeroCotizacion) {
            console.log(`Abriendo desglose: ${numeroCotizacion}`);
            const identificadorCodificado = encodeURIComponent(numeroCotizacion);
            window.location.href = `/desglose/${identificadorCodificado}`;
        }

        // Funci√≥n para nueva cotizaci√≥n
        function verTodos() {
            // Limpiar campo de b√∫squeda y ejecutar b√∫squeda vac√≠a
            document.getElementById('searchInput').value = '';
            buscar();
        }

        function nuevaCotizacion() {
            window.location.href = '/formulario';
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                buscar();
            }
        });

        // Limpiar resultados al vaciar input
        document.getElementById('searchInput').addEventListener('input', function() {
            if (this.value.trim() === '') {
                document.getElementById('resultados').innerHTML = '';
                ultimaBusqueda = '';
            }
        });

        // Auto-focus en el input al cargar
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Sistema CWS iniciado');
            document.getElementById('searchInput').focus();
        });
    </script>
</body>
</html>