<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cotizaci√≥n {{ cotizacion.numeroCotizacion or 'Sin n√∫mero' }}</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 30px;
            background-color: #f8fafc;
            color: #212529;
            line-height: 1.6;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #e2e8f0;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 30px;
            text-align: center;
        }
        .header h1 {
            color: white;
            font-weight: 600;
            font-size: 24px;
            margin: 0;
        }
        .section {
            margin-bottom: 25px;
            padding: 25px;
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
        .section h3 {
            color: #1e293b;
            font-size: 18px;
            font-weight: 600;
            margin: 0 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #3b82f6;
            display: flex;
            align-items: center;
        }
        .section h3::before {
            content: "üìã";
            margin-right: 10px;
        }
        /* MEJORA PRINCIPAL: CSS Grid para alineaci√≥n perfecta */
        .field {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 15px;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f1f5f9;
            margin: 0;
        }
        .field:last-child {
            border-bottom: none;
        }
        .field strong {
            color: #475569;
            font-weight: 600;
            font-size: 14px;
            text-align: right;
            width: auto;
            display: block;
        }
        .field span {
            background: #f8fafc;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            padding: 10px 15px;
            color: #1e293b;
            font-size: 14px;
            box-shadow: inset 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            word-wrap: break-word;
        }
        /* Estilos especiales para campos importantes */
        .field strong:contains("Total") + span,
        .field strong:contains("Subtotal") + span {
            background: #fef3c7;
            border-color: #f59e0b;
            font-weight: 600;
        }
        
        .field strong:contains("Cliente") + span {
            background: #dbeafe;
            border-color: #3b82f6;
        }
        
        .field strong:contains("Proyecto") + span {
            background: #d1fae5;
            border-color: #10b981;
        }

        /* Iconos visuales para campos */
        .field strong:contains("Cliente")::before { 
            content: "üë§ "; 
        }
        .field strong:contains("Proyecto")::before { 
            content: "üìÅ "; 
        }
        .field strong:contains("Fecha")::before { 
            content: "üìÖ "; 
        }
        .field strong:contains("Total")::before { 
            content: "üí∞ "; 
        }
        .field strong:contains("Moneda")::before { 
            content: "üí± "; 
        }
        .field strong:contains("Vendedor")::before { 
            content: "üë®‚Äçüíº "; 
        }

        .actions {
            margin-top: 30px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
            text-align: center;
        }
        
        .btn {
            padding: 12px 24px;
            margin: 8px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 1px solid #d1d5db;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background-color: #ffffff;
            color: #495057;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            text-decoration: none;
            color: #495057;
        }
        
        .btn.primary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border-color: #1d4ed8;
        }
        
        .btn.primary:hover {
            color: white;
        }
        .item-container {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
            background: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        .item-header {
            color: #495057;
            margin-top: 0;
            margin-bottom: 16px;
            font-size: 18px;
            font-weight: 600;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 8px;
        }
        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        .total-value {
            background: #f8f9fa;
            padding: 10px 16px;
            border-radius: 6px;
            font-weight: 600;
            color: #495057;
            border: 1px solid #e9ecef;
        }
        .costo-value {
            background: #f8f9fa;
            padding: 10px 16px;
            border-radius: 6px;
            color: #495057;
            border: 1px solid #e9ecef;
            font-weight: 600;
        }
        
        /* Mejoras para tablas de items */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        table th {
            background: #f1f5f9;
            color: #374151;
            font-weight: 600;
            padding: 12px 15px;
            text-align: left;
            border-bottom: 2px solid #e5e7eb;
        }
        
        table td {
            padding: 12px 15px;
            border-bottom: 1px solid #f3f4f6;
            color: #374151;
        }
        
        table tr:hover {
            background: #f9fafb;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            
            .container {
                padding: 20px;
            }
            
            .field {
                grid-template-columns: 1fr;
                gap: 5px;
                text-align: left;
            }
            
            .field strong {
                text-align: left;
                padding-right: 0;
                margin-bottom: 5px;
                font-size: 13px;
            }
            
            .header {
                padding: 20px 15px;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .section {
                padding: 20px 15px;
                margin-bottom: 20px;
            }
            
            .section h3 {
                font-size: 16px;
            }
            
            table {
                font-size: 12px;
            }
            
            table th, table td {
                padding: 8px 10px;
            }
        }

        @media print {
            .actions {
                display: none;
            }
            
            body {
                background-color: white;
                padding: 0;
            }
            
            .container {
                box-shadow: none;
                border: none;
                padding: 20px 0;
            }
        }
        
        @media (max-width: 768px) {
            .grid-4 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div style="display: flex; justify-content: center; margin-bottom: 16px;">
                <img src="/static/logo.png" alt="CWS Company" style="max-height: 60px; max-width: 150px; object-fit: contain;">
            </div>
            <h1>Cotizaci√≥n {{ cotizacion.numeroCotizacion or 'Sin n√∫mero' }}</h1>
            {% if cotizacion.revision %}
            <p><strong>Revisi√≥n:</strong> {{ cotizacion.revision }}</p>
            {% endif %}
        </div>

        <!-- Datos Generales -->
        <div class="section">
            <h3>Informaci√≥n General</h3>
            
            <div class="field">
                <strong>N√∫mero:</strong>
                <span>{{ cotizacion.numeroCotizacion or 'N/A' }}</span>
            </div>
            <div class="field">
                <strong>Revisi√≥n:</strong>
                <span>{{ cotizacion.revision or 'N/A' }}</span>
            </div>
            
            {% if cotizacion.datosGenerales %}
            <div class="field">
                <strong>Vendedor:</strong>
                <span>{{ cotizacion.datosGenerales.vendedor or 'N/A' }}</span>
            </div>
            <div class="field">
                <strong>Proyecto:</strong>
                <span>{{ cotizacion.datosGenerales.proyecto or 'N/A' }}</span>
            </div>
            <div class="field">
                <strong>Cliente:</strong>
                <span>{{ cotizacion.datosGenerales.cliente or 'N/A' }}</span>
            </div>
            <div class="field">
                <strong>Atenci√≥n a:</strong>
                <span>{{ cotizacion.datosGenerales.atencionA or 'N/A' }}</span>
            </div>
            <div class="field">
                <strong>Contacto:</strong>
                <span>{{ cotizacion.datosGenerales.contacto or 'N/A' }}</span>
            </div>
            
            <!-- Justificaci√≥n de Actualizaci√≥n - Solo para revisiones >= R2 -->
            {% if cotizacion.revision and cotizacion.revision|int >= 2 %}
            <div class="field" style="border-left: 4px solid #f59e0b; padding-left: 16px; background-color: #fef3c7; border-radius: 6px; margin-top: 12px;">
                <strong style="color: #92400e;">üìù Justificaci√≥n de Actualizaci√≥n (R{{ cotizacion.revision }}):</strong>
                <span style="color: #92400e; font-style: italic; font-weight: 500;">
                    {{ cotizacion.datosGenerales.actualizacionRevision or '‚ö†Ô∏è Sin justificaci√≥n registrada' }}
                </span>
            </div>
            {% endif %}
            {% endif %}
        </div>

        <!-- Items -->
        {% if cotizacion.get('items') %}
        <div class="section">
            <h3>Items de Cotizaci√≥n</h3>
            
            {% for item in cotizacion.get('items', []) %}
            <div class="item-container">
                <h4 class="item-header">Item {{ loop.index }}: {{ item.descripcion or 'Sin descripci√≥n' }}</h4>
                
                <!-- Informaci√≥n b√°sica del item -->
                <div class="grid-4">
                    <div class="field">
                        <strong>UOM:</strong>
                        <span>{{ item.uom or 'N/A' }}</span>
                    </div>
                    <div class="field">
                        <strong>Cantidad:</strong>
                        <span>{{ item.cantidad or '0' }}</span>
                    </div>
                    <div class="field">
                        <strong>Costo/Unidad:</strong>
                        <span class="costo-value">${{ item.costoUnidad or '0.00' }}</span>
                    </div>
                    <div class="field">
                        <strong>Total Item:</strong>
                        <span class="total-value">${{ item.total or '0.00' }}</span>
                    </div>
                </div>

                <!-- Costos Adicionales -->
                <div style="margin-top: 15px;">
                    <h5 style="color: #6c757d; margin: 10px 0; font-weight: 600;">Costos y Ajustes:</h5>
                    <div class="grid-4">
                        <div class="field">
                            <strong>Transporte:</strong>
                            <span>${{ item.transporte or '0.00' }}</span>
                        </div>
                        <div class="field">
                            <strong>Instalaci√≥n:</strong>
                            <span>${{ item.instalacion or '0.00' }}</span>
                        </div>
                        <div class="field">
                            <strong>% Seguridad:</strong>
                            <span>{{ item.seguridad or '0' }}%</span>
                        </div>
                        <div class="field">
                            <strong>% Descuento:</strong>
                            <span>{{ item.descuento or '0' }}%</span>
                        </div>
                    </div>
                </div>

                <!-- Materiales del Item -->
                {% if item.get('materiales') %}
                <div style="margin-top: 15px;">
                    <h5 style="color: #dc3545; margin: 10px 0; font-weight: 600;">üî© Materiales:</h5>
                    
                    <table style="width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 12px;">
                        <thead>
                            <tr style="background: #e5e7eb; color: #374151;">
                                <th style="border: 1px solid #d1d5db; padding: 8px; text-align: left;">Descripci√≥n</th>
                                <th style="border: 1px solid #d1d5db; padding: 8px; text-align: center;">Detalle</th>
                                <th style="border: 1px solid #d1d5db; padding: 8px; text-align: center;">Precio/Cantidad</th>
                                <th style="border: 1px solid #d1d5db; padding: 8px; text-align: center;">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for material in item.get('materiales', []) %}
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="border: 1px solid #ddd; padding: 6px; font-weight: bold;">
                                    {% if material.get('material') == 'COTIZAR_POR_PESO' %}
                                        <span style="color: #10b981; font-weight: bold;">‚öñÔ∏è Cotizar por peso</span>
                                    {% else %}
                                        {{ material.get('material') or 'Sin descripci√≥n' }}
                                    {% endif %}
                                </td>
                                <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">
                                    {% if material.get('material') == 'COTIZAR_POR_PESO' %}
                                        <div style="font-size: 11px; line-height: 1.4;">
                                            <strong>Peso estructura:</strong><br>
                                            {{ material.get('pesoEstructura', '0') }} KG
                                        </div>
                                    {% else %}
                                        <div style="font-size: 11px; line-height: 1.4;">
                                            <strong>Peso:</strong> {{ material.get('peso', '0') }} kg<br>
                                            <strong>$/Kg:</strong> ${{ material.get('precio', '0.00') }}
                                        </div>
                                    {% endif %}
                                </td>
                                <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">
                                    {% if material.get('material') == 'COTIZAR_POR_PESO' %}
                                        <div style="font-size: 11px; line-height: 1.4;">
                                            <strong>${{ material.get('precioKg', '0.00') }}/KG</strong>
                                        </div>
                                    {% else %}
                                        <div style="font-size: 11px; line-height: 1.4;">
                                            <strong>Cantidad:</strong> {{ material.get('cantidad', '0') }}
                                        </div>
                                    {% endif %}
                                </td>
                                <td style="border: 1px solid #ddd; padding: 6px; text-align: center; font-weight: bold; color: #dc3545;">
                                    ${{ material.get('subtotal', '0.00') }}
                                    {% if material.get('material') == 'COTIZAR_POR_PESO' %}
                                        <div style="font-size: 10px; color: #6b7280; margin-top: 2px;">
                                            ({{ material.get('pesoEstructura', '0') }} KG √ó ${{ material.get('precioKg', '0.00') }})
                                        </div>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}

                <!-- Otros Materiales del Item -->
                {% if item.get('otrosMateriales') %}
                <div style="margin-top: 15px;">
                    <h5 style="color: #17a2b8; margin: 10px 0; font-weight: 600;">üîß Otros Materiales:</h5>
                    <table style="width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 12px;">
                        <thead>
                            <tr style="background: #e5e7eb; color: #374151;">
                                <th style="border: 1px solid #d1d5db; padding: 8px; text-align: left;">Descripci√≥n</th>
                                <th style="border: 1px solid #d1d5db; padding: 8px; text-align: center;">Precio</th>
                                <th style="border: 1px solid #d1d5db; padding: 8px; text-align: center;">Cantidad</th>
                                <th style="border: 1px solid #d1d5db; padding: 8px; text-align: center;">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for otro in item.get('otrosMateriales', []) %}
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="border: 1px solid #ddd; padding: 6px; font-weight: bold;">{{ otro.get('descripcion', 'Sin descripci√≥n') }}</td>
                                <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">${{ otro.get('precio', '0.00') }}</td>
                                <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">{{ otro.get('cantidad', '0') }}</td>
                                <td style="border: 1px solid #ddd; padding: 6px; text-align: center; font-weight: bold; color: #17a2b8;">${{ otro.get('subtotal', '0.00') }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Condiciones -->
        {% if cotizacion.condiciones %}
        <div class="section">
            <h3>T√©rminos y Condiciones</h3>
            
            <div class="field">
                <strong>Moneda:</strong>
                <span>{{ cotizacion.condiciones.moneda or 'N/A' }}</span>
            </div>
            {% if cotizacion.condiciones.tipoCambio %}
            <div class="field">
                <strong>Tipo de Cambio:</strong>
                <span>{{ cotizacion.condiciones.tipoCambio }}</span>
            </div>
            {% endif %}
            <div class="field">
                <strong>Tiempo de Entrega:</strong>
                <span>{{ cotizacion.condiciones.tiempoEntrega or 'N/A' }} d√≠as h√°biles</span>
            </div>
            <div class="field">
                <strong>Entrega en:</strong>
                <span>{{ cotizacion.condiciones.entregaEn or 'N/A' }}</span>
            </div>
            <div class="field">
                <strong>T√©rminos de Pago:</strong>
                <span>{{ cotizacion.condiciones.terminosPago or cotizacion.condiciones.terminos or 'N/A' }}</span>
            </div>
            {% if cotizacion.condiciones.comentarios %}
            <div class="field">
                <strong>Comentarios:</strong>
                <span style="font-style: italic;">{{ cotizacion.condiciones.comentarios }}</span>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Informaci√≥n del sistema -->
        <div class="section">
            <h3>Informaci√≥n del Sistema</h3>
            <div class="field">
                <strong>ID:</strong>
                <span style="font-family: monospace; font-size: 12px;">{{ cotizacion._id or 'N/A' }}</span>
            </div>
            <div class="field">
                <strong>Fecha de Creaci√≥n:</strong>
                <span>{{ cotizacion.fechaCreacion or 'N/A' }}</span>
            </div>
            {% if cotizacion.version %}
            <div class="field">
                <strong>Versi√≥n del Sistema:</strong>
                <span>{{ cotizacion.version }}</span>
            </div>
            {% endif %}
        </div>

        
        <!-- Acciones -->
        <div class="actions">
            <a href="/" class="btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z"/>
                </svg>
                Inicio
            </a>
            <a href="/formulario" class="btn primary">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                </svg>
                Nueva Cotizaci√≥n
            </a>
            {% set numero_cotizacion = cotizacion.get('numeroCotizacion') or cotizacion.get('numero_cotizacion') or cotizacion.get('_id') %}
            {% if numero_cotizacion %}
            <a href="/formulario?revision={{ numero_cotizacion | urlencode }}" class="btn" style="background-color: #10b981; color: white; border-color: #10b981;" title="Crear nueva revisi√≥n basada en {{ numero_cotizacion }}">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17,13H13V17H11V13H7V11H11V7H13V11H17M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"/>
                </svg>
                Nueva Revisi√≥n
            </a>
            {% endif %}
            
            <!-- Bot√≥n para an√°lisis BOM con Gemini AI -->
            {% if numero_cotizacion %}
            <button onclick="analizarBOM('{{ numero_cotizacion }}')" class="btn" style="background-color: #9333ea; color: white; border-color: #9333ea;" title="Analizar PDF con Gemini AI para extraer Bill of Materials">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M11,16.5L6.5,12L7.91,10.59L11,13.67L16.59,8.09L18,9.5L11,16.5Z"/>
                </svg>
                Analizar BOM
            </button>
            <a href="/bom_analysis?cotizacion={{ numero_cotizacion | urlencode }}" class="btn" style="background-color: #0891b2; color: white; border-color: #0891b2;" title="Ver an√°lisis BOM existentes para {{ numero_cotizacion }}">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                </svg>
                Ver BOM
            </a>
            {% endif %}
            
            <button onclick="window.print()" class="btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M18,3H6V7H18M19,12A1,1 0 0,1 18,11A1,1 0 0,1 19,10A1,1 0 0,1 20,11A1,1 0 0,1 19,12M16,19H8V14H16M19,8H5A3,3 0 0,0 2,11V17H6V21H18V17H22V11A3,3 0 0,0 19,8Z"/>
                </svg>
                Imprimir
            </button>
        </div>
    </div>

    <script>
        async function analizarBOM(numeroCotizacion) {
            const botonBOM = event.target;
            const textoOriginal = botonBOM.innerHTML;
            
            // Deshabilitar bot√≥n y mostrar estado de carga
            botonBOM.disabled = true;
            botonBOM.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="animation: spin 1s linear infinite;">
                    <path d="M12,4V2A10,10 0 0,0 2,12H4A8,8 0 0,1 12,4Z"/>
                </svg>
                Analizando...
            `;
            
            try {
                console.log('Iniciando an√°lisis BOM para:', numeroCotizacion);
                
                // Verificar capacidad del PDF primero
                const verificarResponse = await fetch('/verificar_pdf_bom', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ruta_pdf: numeroCotizacion + '.pdf'
                    })
                });
                
                const verificacion = await verificarResponse.json();
                console.log('Verificaci√≥n PDF BOM:', verificacion);
                
                if (!verificacion.bom_disponible) {
                    alert('‚ùå Sistema BOM no disponible\n\nEl an√°lisis con Gemini AI no est√° configurado. Contacte al administrador.');
                    return;
                }
                
                if (!verificacion.capacidad.analizable) {
                    alert('‚ö†Ô∏è PDF no analizable\n\nRaz√≥n: ' + (verificacion.capacidad.razon || 'PDF no encontrado o no v√°lido'));
                    return;
                }
                
                // Confirmar an√°lisis con el usuario
                const confirmar = confirm(`ü§ñ An√°lisis BOM con Gemini AI\n\n` +
                    `Cotizaci√≥n: ${numeroCotizacion}\n` +
                    `PDF: ${verificacion.capacidad.estadisticas?.numero_paginas || 'N/A'} p√°ginas\n\n` +
                    `El an√°lisis seguir√° estos 5 pasos:\n` +
                    `1. An√°lisis p√°gina por p√°gina\n` +
                    `2. Extracci√≥n de tablas de materiales\n` +
                    `3. Procesamiento completo\n` +
                    `4. Consolidaci√≥n en tabla master\n` +
                    `5. Grand total con materiales repetidos\n\n` +
                    `¬øContinuar con el an√°lisis?`
                );
                
                if (!confirmar) {
                    return;
                }
                
                // Ejecutar an√°lisis BOM completo
                console.log('Ejecutando an√°lisis BOM completo...');
                const analisisResponse = await fetch('/analizar_pdf_bom', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ruta_pdf: numeroCotizacion + '.pdf',
                        numero_cotizacion: numeroCotizacion
                    })
                });
                
                const resultado = await analisisResponse.json();
                console.log('Resultado an√°lisis BOM:', resultado);
                
                if (resultado.exito) {
                    const stats = resultado.resultado.estadisticas;
                    const mensaje = `‚úÖ An√°lisis BOM completado exitosamente!\n\n` +
                        `üìä Resultados:\n` +
                        `‚Ä¢ P√°ginas analizadas: ${stats.total_paginas_analizadas || 0}\n` +
                        `‚Ä¢ Items encontrados: ${stats.total_items_encontrados || 0}\n` +
                        `‚Ä¢ Items √∫nicos: ${stats.total_items_unicos || 0}\n` +
                        `‚Ä¢ Items consolidados: ${stats.total_items_consolidados || 0}\n` +
                        `‚Ä¢ P√°ginas con tablas: ${stats.paginas_con_tablas || 0}\n\n` +
                        `¬øVer resultados detallados?`;
                    
                    if (confirm(mensaje)) {
                        window.open(`/bom_analysis?id=${resultado.resultado.analysis_id}`, '_blank');
                    }
                } else {
                    const error = resultado.error || resultado.resultado?.error || 'Error desconocido';
                    let mensajeError = `‚ùå Error en an√°lisis BOM\n\n${error}`;
                    
                    // Agregar contexto espec√≠fico para errores conocidos
                    if (error.includes('[Errno 22]') || error.includes('Invalid argument')) {
                        mensajeError += `\n\nüîß SOLUCI√ìN APLICADA:\n` +
                            `‚Ä¢ Se instal√≥ poppler-utils autom√°ticamente\n` +
                            `‚Ä¢ Se mejor√≥ el manejo de rutas de Windows\n` +
                            `‚Ä¢ Se activ√≥ sistema fallback (solo texto)\n\n` +
                            `Si persiste, el PDF puede no ser compatible.`;
                    } else if (error.includes('pdf2image')) {
                        mensajeError += `\n\nüîß PROBLEMA PDF2IMAGE:\n` +
                            `‚Ä¢ Error de conversi√≥n PDF a imagen\n` +
                            `‚Ä¢ Se intentar√° usar sistema fallback\n` +
                            `‚Ä¢ Verifique que el PDF no est√© corrupto`;
                    } else if (error.includes('Permission denied')) {
                        mensajeError += `\n\nüîê PROBLEMA PERMISOS:\n` +
                            `‚Ä¢ Sin acceso al archivo PDF\n` +
                            `‚Ä¢ Cierre el PDF si est√° abierto\n` +
                            `‚Ä¢ Ejecute como administrador si es necesario`;
                    } else if (error.includes('File not found') || error.includes('No such file')) {
                        mensajeError += `\n\nüìÅ ARCHIVO NO ENCONTRADO:\n` +
                            `‚Ä¢ Verifique que el PDF est√© subido\n` +
                            `‚Ä¢ Revise el nombre de la cotizaci√≥n\n` +
                            `‚Ä¢ El archivo debe existir en el sistema`;
                    } else if (error.includes('quota') || error.includes('limit')) {
                        mensajeError += `\n\n‚è±Ô∏è L√çMITE GEMINI AI:\n` +
                            `‚Ä¢ Cuota de API agotada temporalmente\n` +
                            `‚Ä¢ Espere unos minutos e intente de nuevo\n` +
                            `‚Ä¢ Considere usar un modelo m√°s eficiente`;
                    }
                    
                    mensajeError += `\n\nüìã Detalles t√©cnicos disponibles en logs del sistema.`;
                    alert(mensajeError);
                }
                
            } catch (error) {
                console.error('Error en an√°lisis BOM:', error);
                let mensajeConexion = `üö® Error de conexi√≥n\n\nNo se pudo ejecutar el an√°lisis BOM.\nError: ${error.message}`;
                
                // Contexto adicional seg√∫n el tipo de error
                if (error.message.includes('fetch')) {
                    mensajeConexion += `\n\nüåê PROBLEMA DE RED:\n` +
                        `‚Ä¢ Verifique conexi√≥n a internet\n` +
                        `‚Ä¢ El servidor Flask debe estar ejecut√°ndose\n` +
                        `‚Ä¢ Puerto 5000 debe estar disponible`;
                } else if (error.message.includes('timeout')) {
                    mensajeConexion += `\n\n‚è±Ô∏è TIMEOUT:\n` +
                        `‚Ä¢ El an√°lisis tom√≥ m√°s tiempo del esperado\n` +
                        `‚Ä¢ PDFs grandes pueden tardar varios minutos\n` +
                        `‚Ä¢ Intente con un PDF m√°s peque√±o`;
                } else if (error.message.includes('JSON')) {
                    mensajeConexion += `\n\nüìÑ RESPUESTA INV√ÅLIDA:\n` +
                        `‚Ä¢ Error en el formato de respuesta del servidor\n` +
                        `‚Ä¢ Revise logs del servidor Flask\n` +
                        `‚Ä¢ Posible error interno del sistema`;
                }
                
                alert(mensajeConexion);
            } finally {
                // Restaurar bot√≥n original
                botonBOM.disabled = false;
                botonBOM.innerHTML = textoOriginal;
            }
        }
    </script>
    
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</body>
</html>