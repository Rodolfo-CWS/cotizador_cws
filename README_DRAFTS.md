# Sistema de Drafts (Borradores) - Cotizador CWS

## Descripci√≥n General

Sistema completo de auto-guardado de borradores para cotizaciones, permitiendo a los usuarios guardar autom√°ticamente su trabajo y continuar editando m√°s tarde.

## Caracter√≠sticas Implementadas

### 1. Auto-Guardado Autom√°tico
- ‚è∞ **Guardado cada 30 segundos**: Mientras el usuario edita el formulario
- üîÑ **Guardado antes de cerrar**: Usa `beforeunload` y `sendBeacon` para garantizar guardado
- üéØ **Inteligente**: Solo guarda si hay cambios y datos v√°lidos
- üíæ **Almacenamiento dual**: Supabase (primario) + JSON local (fallback)

### 2. Notificaci√≥n Discreta en Home
- üîî **Badge con contador**: Muestra n√∫mero de borradores pendientes
- üé® **Dise√±o discreto**: Bot√≥n naranja con √≠cono de borrador
- üìä **Actualizaci√≥n autom√°tica**: Se actualiza al cargar la p√°gina

### 3. Gesti√≥n Completa de Drafts
- üìã **Listar borradores**: Modal con todos los borradores del usuario
- ‚úèÔ∏è **Continuar editando**: Carga borrador en formulario con un clic
- üóëÔ∏è **Eliminar borradores**: Con confirmaci√≥n para evitar p√©rdidas accidentales
- üìÖ **Informaci√≥n completa**: Nombre, vendedor, fecha de √∫ltima modificaci√≥n

### 4. Integraci√≥n Transparente
- üîó **URL con par√°metro**: `/formulario?draft=ID` carga borrador autom√°ticamente
- üöÄ **Sin interrupciones**: El sistema funciona sin afectar flujo normal
- üí™ **Robusto**: Manejo de errores y fallbacks autom√°ticos

## Estructura de Archivos Modificados

### Backend (Python/Flask)

#### `supabase_manager.py`
**M√©todos agregados:**
- `guardar_draft(datos)` - Guarda/actualiza draft en Supabase y JSON
- `listar_drafts(vendedor)` - Lista drafts opcionalmente filtrados por vendedor
- `obtener_draft(draft_id)` - Obtiene datos completos de un draft
- `eliminar_draft(draft_id)` - Elimina draft de Supabase y JSON

**L√≠neas modificadas:** 1927-2218 (292 l√≠neas agregadas)

#### `app.py`
**Endpoints agregados:**
- `POST /api/draft/save` - Guardar/actualizar draft
- `GET /api/draft/list` - Listar drafts (opcionalmente filtrados)
- `GET /api/draft/load/<id>` - Cargar draft espec√≠fico
- `DELETE /api/draft/delete/<id>` - Eliminar draft

**L√≠neas modificadas:** 1669-1845 (177 l√≠neas agregadas)

### Frontend (HTML/JavaScript)

#### `templates/formulario.html`
**Funcionalidades agregadas:**
- Sistema de auto-guardado con timer de 30 segundos
- Detecci√≥n de cambios en formulario
- Funciones de recopilaci√≥n de datos (datosGenerales, items, condiciones)
- Carga autom√°tica de draft desde URL
- Notificaci√≥n visual de guardado exitoso

**L√≠neas modificadas:** 518-829 (311 l√≠neas agregadas)

#### `templates/home.html`
**Componentes agregados:**
- Bot√≥n de "Borradores" con badge de contador
- Modal completo para gesti√≥n de drafts
- Funciones JavaScript para:
  - Cargar conteo de drafts al inicio
  - Abrir modal y listar drafts
  - Cargar draft seleccionado
  - Eliminar draft con confirmaci√≥n
  - Cerrar modal

**L√≠neas modificadas:** 386-842 (457 l√≠neas agregadas)

### Base de Datos

#### `create_drafts_table.sql`
**Estructura de tabla:**
```sql
CREATE TABLE public.drafts (
    id TEXT PRIMARY KEY,
    vendedor TEXT NOT NULL,
    nombre TEXT NOT NULL,
    datos JSONB NOT NULL,
    timestamp BIGINT NOT NULL,
    fecha_creacion TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    ultima_modificacion TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);
```

**√çndices creados:**
- `idx_drafts_vendedor` - Para filtrar por vendedor
- `idx_drafts_timestamp` - Para ordenamiento
- `idx_drafts_ultima_modificacion` - Para listar por m√°s recientes

#### `drafts_offline.json` (Generado autom√°ticamente)
**Estructura:**
```json
{
  "drafts": [
    {
      "id": "draft_1234567890",
      "vendedor": "RCWS",
      "nombre": "Cliente X - Proyecto Y",
      "datos": {
        "datosGenerales": {...},
        "items": [...],
        "condiciones": {...}
      },
      "timestamp": 1234567890,
      "fecha_creacion": "2025-10-24T10:30:00",
      "ultima_modificacion": "2025-10-24T11:00:00"
    }
  ]
}
```

## Instalaci√≥n y Configuraci√≥n

### 1. Crear Tabla en Supabase

**Opci√≥n A: Desde Supabase Dashboard**
1. Ir a SQL Editor en Supabase Dashboard
2. Copiar contenido de `create_drafts_table.sql`
3. Ejecutar script
4. Verificar que la tabla se cre√≥ correctamente

**Opci√≥n B: Desde l√≠nea de comandos**
```bash
# Usando psql
psql $DATABASE_URL -f create_drafts_table.sql
```

### 2. Verificar Variables de Entorno

Asegurar que est√©n configuradas en el entorno (local) o Render (producci√≥n):

```env
# Supabase (requeridas)
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_ANON_KEY=xxx
SUPABASE_SERVICE_KEY=xxx
DATABASE_URL=postgresql://postgres.xxx:xxx@xxx.supabase.com:6543/postgres
```

### 3. Instalar Dependencias (si es necesario)

```bash
pip install supabase psycopg2-binary
```

### 4. Reiniciar Aplicaci√≥n

```bash
# Local
python app.py

# Producci√≥n (Render)
# Push a GitHub - Render auto-deploya
```

## Uso del Sistema

### Para Usuarios Finales

#### Crear/Editar Cotizaci√≥n con Auto-Guardado

1. **Ir a formulario de cotizaci√≥n**
   - Click en "Nueva Cotizaci√≥n" desde home
   - O abrir cotizaci√≥n existente para revisi√≥n

2. **Empezar a llenar datos**
   - El sistema detecta autom√°ticamente cambios
   - Cada 30 segundos guarda autom√°ticamente como borrador
   - Aparece notificaci√≥n verde "Borrador guardado" al guardar

3. **Salir sin completar**
   - Simplemente cerrar pesta√±a o volver atr√°s
   - El sistema guarda autom√°ticamente antes de cerrar (usando `sendBeacon`)

#### Ver y Gestionar Borradores

1. **Desde home, click en bot√≥n "Borradores"** (naranja con √≠cono de rayo)
   - Si hay borradores pendientes, se muestra badge rojo con n√∫mero

2. **En el modal de borradores:**
   - Ver lista de todos los borradores con:
     - Nombre (Cliente - Proyecto)
     - Vendedor
     - Fecha de √∫ltima modificaci√≥n
   - **Continuar editando**: Click en bot√≥n azul - carga borrador en formulario
   - **Eliminar**: Click en bot√≥n rojo - elimina despu√©s de confirmar

3. **Trabajar con borrador cargado:**
   - El formulario se llena autom√°ticamente con todos los datos
   - Continuar editando normalmente
   - El auto-guardado actualiza el mismo borrador
   - Al generar cotizaci√≥n final, el borrador se puede eliminar manualmente

### Para Desarrolladores

#### API Endpoints

**POST `/api/draft/save`**
```json
// Request
{
  "vendedor": "RCWS",
  "datos": {
    "datosGenerales": {...},
    "items": [...],
    "condiciones": {...}
  },
  "draft_id": "draft_123" // opcional para actualizar
}

// Response
{
  "success": true,
  "draft_id": "draft_1234567890",
  "timestamp": 1234567890,
  "nombre": "Cliente X - Proyecto Y"
}
```

**GET `/api/draft/list?vendedor=RCWS`** (vendedor opcional)
```json
{
  "success": true,
  "drafts": [
    {
      "id": "draft_123",
      "vendedor": "RCWS",
      "nombre": "Cliente X - Proyecto Y",
      "timestamp": 1234567890,
      "fecha_creacion": "2025-10-24T10:30:00",
      "ultima_modificacion": "2025-10-24T11:00:00"
    }
  ],
  "total": 1
}
```

**GET `/api/draft/load/<draft_id>`**
```json
{
  "success": true,
  "draft": {
    "id": "draft_123",
    "vendedor": "RCWS",
    "nombre": "Cliente X - Proyecto Y",
    "datos": {
      "datosGenerales": {...},
      "items": [...],
      "condiciones": {...}
    },
    "timestamp": 1234567890,
    "fecha_creacion": "2025-10-24T10:30:00",
    "ultima_modificacion": "2025-10-24T11:00:00"
  }
}
```

**DELETE `/api/draft/delete/<draft_id>`**
```json
{
  "success": true,
  "mensaje": "Draft draft_123 eliminado"
}
```

#### Funciones JavaScript Principales

**En `formulario.html`:**
- `inicializarSistemaAutoGuardado()` - Inicia timer y listeners
- `autoGuardarDraft()` - Ejecuta guardado peri√≥dico
- `autoGuardarDraftSincrono()` - Guardado antes de cerrar ventana
- `recopilarDatosGenerales()` - Extrae datos generales del formulario
- `recopilarItems()` - Extrae items/productos del formulario
- `recopilarCondiciones()` - Extrae condiciones comerciales
- `cargarDraftSeleccionado(id)` - Carga draft en formulario
- `mostrarNotificacionGuardado()` - Muestra notificaci√≥n temporal

**En `home.html`:**
- `cargarConteoDrafts()` - Actualiza badge con n√∫mero de drafts
- `abrirModalDrafts()` - Abre modal y carga lista
- `cerrarModalDrafts()` - Cierra modal
- `cargarDraft(id)` - Redirige a formulario con draft
- `eliminarDraft(id)` - Elimina draft con confirmaci√≥n

## Testing

### Pruebas Manuales

1. **Test de Auto-Guardado:**
   - Abrir formulario nuevo
   - Llenar algunos campos (cliente, proyecto, items)
   - Esperar 30 segundos
   - Verificar notificaci√≥n "Borrador guardado"
   - Cerrar pesta√±a sin guardar
   - Volver al home
   - Verificar badge con "1" en bot√≥n Borradores

2. **Test de Cargar Borrador:**
   - Click en bot√≥n "Borradores"
   - Verificar que aparece el borrador guardado
   - Click en "Continuar editando"
   - Verificar que formulario se llena con datos guardados
   - Verificar que subtotales se recalculan correctamente

3. **Test de Eliminar Borrador:**
   - Abrir modal de borradores
   - Click en "Eliminar" en un borrador
   - Confirmar eliminaci√≥n
   - Verificar que borrador desaparece de lista
   - Verificar que badge actualiza el contador

4. **Test de M√∫ltiples Borradores:**
   - Crear 3 cotizaciones diferentes sin completar
   - Esperar auto-guardado en cada una
   - Verificar badge muestra "3"
   - Verificar lista muestra los 3 borradores ordenados por fecha

5. **Test de Fallback Offline:**
   - Desconectar de internet (o detener Supabase)
   - Llenar formulario y esperar auto-guardado
   - Verificar que guarda en `drafts_offline.json`
   - Reconectar
   - Verificar sincronizaci√≥n (si hay mecanismo de sync)

### Pruebas Automatizadas

```bash
# Ejecutar script de prueba
python test_drafts.py

# El script prueba:
# - Guardar draft
# - Listar drafts
# - Obtener draft espec√≠fico
# - Actualizar draft existente
# - Eliminar draft
# - Fallback a JSON
```

## Arquitectura T√©cnica

### Flujo de Auto-Guardado

```
Usuario edita formulario
    ‚Üì
Event listeners detectan cambios (formModificado = true)
    ‚Üì
Timer (30 segundos) ejecuta autoGuardarDraft()
    ‚Üì
Recopila datos del formulario
    ‚Üì
POST /api/draft/save
    ‚Üì
Backend intenta guardar en Supabase
    ‚Üì (si falla)
Fallback a drafts_offline.json
    ‚Üì
Respuesta exitosa
    ‚Üì
Actualiza draftActualId
Marca formModificado = false
Muestra notificaci√≥n
```

### Flujo de Cargar Borrador

```
Usuario click en "Borradores"
    ‚Üì
GET /api/draft/list
    ‚Üì
Muestra lista en modal
    ‚Üì
Usuario click "Continuar editando"
    ‚Üì
Redirige a /formulario?draft=ID
    ‚Üì
Formulario detecta par√°metro draft en URL
    ‚Üì
GET /api/draft/load/<ID>
    ‚Üì
Llena formulario con datos
Recalcula totales
Establece draftActualId
```

### Arquitectura de Almacenamiento

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   FRONTEND      ‚îÇ
‚îÇ  (formulario)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚Üì POST /api/draft/save
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   BACKEND       ‚îÇ
‚îÇ   (Flask)       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚Üì          ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Supabase‚îÇ  ‚îÇ JSON Local   ‚îÇ
‚îÇ (tabla  ‚îÇ  ‚îÇ (drafts_     ‚îÇ
‚îÇ drafts) ‚îÇ  ‚îÇ offline.json)‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
 Primary      Fallback
```

## Troubleshooting

### Problema: Badge no muestra contador

**Causa:** No hay conexi√≥n a backend o drafts vac√≠os

**Soluci√≥n:**
1. Verificar consola del navegador: `[DRAFT] X borradores pendientes`
2. Verificar que `/api/draft/list` responde correctamente
3. Verificar que hay drafts en la base de datos o JSON

### Problema: Auto-guardado no funciona

**Causa:** Timer no se inicia o datos inv√°lidos

**Soluci√≥n:**
1. Verificar consola: `[DRAFT] Inicializando sistema de auto-guardado...`
2. Verificar que formModificado se activa al editar
3. Asegurar que hay vendedor o cliente en formulario
4. Revisar logs del servidor para errores en `/api/draft/save`

### Problema: Borrador no carga en formulario

**Causa:** ID incorrecto o datos corruptos

**Soluci√≥n:**
1. Verificar URL tiene par√°metro: `/formulario?draft=ID`
2. Verificar consola: `[DRAFT] Draft ID detectado en URL: ...`
3. Verificar que `/api/draft/load/<ID>` devuelve datos v√°lidos
4. Revisar estructura de datos en base de datos

### Problema: Drafts no se guardan en producci√≥n

**Causa:** Tabla no creada en Supabase o permisos RLS

**Soluci√≥n:**
1. Ejecutar `create_drafts_table.sql` en Supabase
2. Verificar pol√≠ticas RLS permiten lectura/escritura
3. Verificar `SUPABASE_SERVICE_KEY` configurada en Render
4. Revisar logs de Render para errores

## Mejoras Futuras

### Corto Plazo
- [ ] Limpieza autom√°tica de drafts antiguos (>30 d√≠as)
- [ ] Opci√≥n de "Guardar como borrador" manual adem√°s del auto-guardado
- [ ] Preview de borrador sin abrir formulario completo
- [ ] B√∫squeda/filtrado de borradores por cliente o proyecto

### Mediano Plazo
- [ ] Sincronizaci√≥n autom√°tica JSON ‚Üí Supabase cuando vuelve conexi√≥n
- [ ] Compartir borradores entre usuarios del mismo equipo
- [ ] Historial de versiones de borradores
- [ ] Restaurar borradores eliminados (papelera)

### Largo Plazo
- [ ] Colaboraci√≥n en tiempo real en borradores
- [ ] Notificaciones push cuando otro usuario edita borrador compartido
- [ ] Plantillas de borradores para cotizaciones recurrentes
- [ ] Exportar/importar borradores

## Estad√≠sticas de Implementaci√≥n

- **Archivos creados:** 3 (`create_drafts_table.sql`, `test_drafts.py`, `README_DRAFTS.md`)
- **Archivos modificados:** 3 (`supabase_manager.py`, `app.py`, `templates/formulario.html`, `templates/home.html`)
- **L√≠neas de c√≥digo agregadas:** ~1,237 l√≠neas
  - Backend: ~469 l√≠neas
  - Frontend: ~768 l√≠neas
- **Endpoints nuevos:** 4
- **Funciones JavaScript nuevas:** 12
- **M√©todos Python nuevos:** 4
- **Tiempo de implementaci√≥n:** ~2 horas

## Conclusi√≥n

El sistema de drafts est√° completamente implementado y listo para producci√≥n. Proporciona una experiencia de usuario fluida con auto-guardado transparente y gesti√≥n completa de borradores pendientes.

La arquitectura h√≠brida (Supabase + JSON) garantiza que los usuarios nunca pierdan su trabajo, incluso sin conexi√≥n a internet.

---

**√öltima actualizaci√≥n:** 24 de octubre de 2025
**Versi√≥n:** 1.0.0
**Autor:** Claude Code (Anthropic)
**Proyecto:** CWS Cotizador
