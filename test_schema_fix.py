#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
TEST SCHEMA FIX - Verificar que el esquema corregido funciona
=============================================================

Este script verifica que el esquema de Supabase est√© completo y funcional
despu√©s de ejecutar fix_supabase_schema.sql

Caracter√≠sticas:
- Verifica que las tablas existan
- Prueba la inserci√≥n de datos
- Confirma que la columna 'condiciones' funciona
- Valida los contadores autom√°ticos
- Prueba el flujo completo de guardado
"""

import os
import sys
import json
import time
from datetime import datetime
from dotenv import load_dotenv

# Cargar variables de entorno
load_dotenv()

# Importar el manager de Supabase
try:
    from supabase_manager import SupabaseManager
    print("[OK] SupabaseManager importado correctamente")
except ImportError as e:
    print(f"‚ùå Error importando SupabaseManager: {e}")
    sys.exit(1)

def test_conexion_supabase():
    """Test 1: Verificar conexi√≥n a Supabase"""
    print("\n" + "="*60)
    print("TEST 1: CONEXI√ìN A SUPABASE")
    print("="*60)
    
    try:
        db = SupabaseManager()
        
        if db.modo_offline:
            print(f"‚ùå FALLO: Supabase en modo offline")
            print(f"   Variables verificadas:")
            print(f"   - SUPABASE_URL: {'‚úÖ' if db.supabase_url else '‚ùå'}")
            print(f"   - SUPABASE_ANON_KEY: {'‚úÖ' if db.supabase_key else '‚ùå'}")
            print(f"   - DATABASE_URL: {'‚úÖ' if db.database_url else '‚ùå'}")
            return False
        else:
            print(f"‚úÖ √âXITO: Conectado a Supabase PostgreSQL")
            print(f"   URL: {db.supabase_url}")
            return True
            
    except Exception as e:
        print(f"‚ùå ERROR: {e}")
        return False

def test_tablas_existen(db):
    """Test 2: Verificar que las tablas necesarias existan"""
    print("\n" + "="*60)
    print("TEST 2: VERIFICAR TABLAS")
    print("="*60)
    
    try:
        cursor = db.pg_connection.cursor()
        
        # Lista de tablas requeridas
        tablas_requeridas = ['cotizaciones', 'cotizacion_counters', 'pdf_storage']
        tablas_encontradas = []
        
        for tabla in tablas_requeridas:
            cursor.execute("""
                SELECT EXISTS (
                    SELECT FROM information_schema.tables 
                    WHERE table_schema = 'public' 
                    AND table_name = %s
                );
            """, (tabla,))
            
            existe = cursor.fetchone()[0]
            if existe:
                tablas_encontradas.append(tabla)
                print(f"‚úÖ Tabla '{tabla}' existe")
            else:
                print(f"‚ùå Tabla '{tabla}' NO existe")
        
        cursor.close()
        
        if len(tablas_encontradas) == len(tablas_requeridas):
            print(f"\n‚úÖ √âXITO: Todas las tablas necesarias existen ({len(tablas_encontradas)}/{len(tablas_requeridas)})")
            return True
        else:
            print(f"\n‚ùå FALLO: Faltan tablas ({len(tablas_encontradas)}/{len(tablas_requeridas)})")
            return False
            
    except Exception as e:
        print(f"‚ùå ERROR verificando tablas: {e}")
        return False

def test_estructura_cotizaciones(db):
    """Test 3: Verificar estructura de tabla cotizaciones"""
    print("\n" + "="*60)
    print("TEST 3: ESTRUCTURA TABLA COTIZACIONES")
    print("="*60)
    
    try:
        cursor = db.pg_connection.cursor()
        
        # Verificar columnas de la tabla cotizaciones
        cursor.execute("""
            SELECT column_name, data_type, is_nullable
            FROM information_schema.columns 
            WHERE table_name = 'cotizaciones'
                AND table_schema = 'public'
            ORDER BY ordinal_position;
        """)
        
        columnas = cursor.fetchall()
        cursor.close()
        
        # Columnas requeridas
        columnas_requeridas = [
            'id', 'numero_cotizacion', 'datos_generales', 'items', 
            'condiciones', 'revision', 'version', 'fecha_creacion', 
            'timestamp', 'usuario', 'observaciones'
        ]
        
        columnas_encontradas = [col[0] for col in columnas]
        
        print("Columnas encontradas:")
        for col in columnas:
            nullable = "NULL" if col[2] == 'YES' else "NOT NULL"
            print(f"  - {col[0]}: {col[1]} {nullable}")
        
        # Verificar que todas las columnas requeridas existan
        columnas_faltantes = []
        for col_req in columnas_requeridas:
            if col_req not in columnas_encontradas:
                columnas_faltantes.append(col_req)
        
        if columnas_faltantes:
            print(f"\n‚ùå FALLO: Faltan columnas: {columnas_faltantes}")
            return False
        else:
            print(f"\n‚úÖ √âXITO: Todas las columnas necesarias existen")
            
            # Verificar espec√≠ficamente la columna 'condiciones'
            condiciones_col = next((col for col in columnas if col[0] == 'condiciones'), None)
            if condiciones_col and 'jsonb' in condiciones_col[1].lower():
                print("‚úÖ Columna 'condiciones' es JSONB correctamente")
                return True
            else:
                print("‚ùå Columna 'condiciones' no es JSONB")
                return False
                
    except Exception as e:
        print(f"‚ùå ERROR verificando estructura: {e}")
        return False

def test_insertar_cotizacion_completa(db):
    """Test 4: Probar inserci√≥n de cotizaci√≥n con condiciones"""
    print("\n" + "="*60)
    print("TEST 4: INSERTAR COTIZACI√ìN COMPLETA")
    print("="*60)
    
    try:
        # Datos de prueba completos con condiciones
        test_timestamp = int(time.time())
        datos_test = {
            'numeroCotizacion': f'SCHEMA-TEST-CWS-FX-{test_timestamp}-R1-VALIDACION',
            'datosGenerales': {
                'cliente': 'SCHEMA-TEST-CLIENT',
                'vendedor': 'SCHEMA VALIDATOR',
                'proyecto': 'VALIDACION-ESQUEMA',
                'atencionA': 'Test Engineer',
                'contacto': 'test@schemafix.com',
                'fecha': datetime.now().strftime('%Y-%m-%d'),
                'validez': '30 dias'
            },
            'items': [
                {
                    'descripcion': 'Item de prueba para validaci√≥n de esquema',
                    'cantidad': 1,
                    'precio_unitario': 100.0,
                    'subtotal': 100.0
                }
            ],
            'condiciones': {
                'moneda': 'USD',
                'tipoCambio': '1.00',
                'tiempoEntrega': '7 dias laborales',
                'entregaEn': 'Oficinas del cliente',
                'terminos': 'NET 30',
                'comentarios': 'Prueba de inserci√≥n con condiciones completas'
            },
            'observaciones': 'Cotizaci√≥n de prueba para validar esquema corregido',
            'revision': 1,
            'version': '1.0.0',
            'timestamp': test_timestamp * 1000  # milliseconds
        }
        
        print("üì§ Intentando guardar cotizaci√≥n de prueba...")
        print(f"   Cliente: {datos_test['datosGenerales']['cliente']}")
        print(f"   N√∫mero: {datos_test['numeroCotizacion']}")
        print(f"   Condiciones incluidas: {bool(datos_test['condiciones'])}")
        
        # Usar SupabaseManager para guardar
        resultado = db.guardar_cotizacion(datos_test)
        
        if resultado.get('success'):
            numero_guardado = resultado.get('numero_cotizacion') or resultado.get('numeroCotizacion')
            print(f"‚úÖ √âXITO: Cotizaci√≥n guardada correctamente")
            print(f"   ID: {resultado.get('id', 'N/A')}")
            print(f"   N√∫mero: {numero_guardado}")
            print(f"   Modo: {resultado.get('modo', 'N/A')}")
            
            # Verificar que se puede recuperar
            print("\nüîç Verificando recuperaci√≥n de datos...")
            recuperada = db.obtener_cotizacion(numero_guardado)
            
            if recuperada.get('encontrado'):
                cotizacion = recuperada['item']
                print("‚úÖ Cotizaci√≥n recuperada exitosamente")
                
                # Verificar que las condiciones se guardaron
                condiciones_recuperadas = cotizacion.get('condiciones', {})
                if condiciones_recuperadas and condiciones_recuperadas.get('moneda') == 'USD':
                    print("‚úÖ Campo 'condiciones' guardado y recuperado correctamente")
                    print(f"   Moneda: {condiciones_recuperadas.get('moneda')}")
                    print(f"   T√©rminos: {condiciones_recuperadas.get('terminos')}")
                    
                    # Limpiar datos de test
                    try:
                        cursor = db.pg_connection.cursor()
                        cursor.execute("DELETE FROM cotizaciones WHERE numero_cotizacion = %s", (numero_guardado,))
                        db.pg_connection.commit()
                        cursor.close()
                        print("üßπ Datos de prueba limpiados")
                    except:
                        print("‚ö†Ô∏è No se pudieron limpiar los datos de prueba")
                    
                    return True
                else:
                    print("‚ùå Campo 'condiciones' no se guard√≥ correctamente")
                    return False
            else:
                print("‚ùå No se pudo recuperar la cotizaci√≥n guardada")
                return False
        else:
            error = resultado.get('error', 'Error desconocido')
            print(f"‚ùå FALLO: Error guardando cotizaci√≥n: {error}")
            return False
            
    except Exception as e:
        print(f"‚ùå ERROR en test de inserci√≥n: {e}")
        return False

def test_contadores_atomicos(db):
    """Test 5: Probar sistema de contadores at√≥micos"""
    print("\n" + "="*60)
    print("TEST 5: CONTADORES AT√ìMICOS")
    print("="*60)
    
    try:
        # Verificar que la tabla de contadores existe y tiene datos
        cursor = db.pg_connection.cursor()
        cursor.execute("SELECT COUNT(*) FROM cotizacion_counters;")
        count = cursor.fetchone()[0]
        cursor.close()
        
        print(f"üìä Contadores configurados: {count}")
        
        if count > 0:
            # Probar generaci√≥n de n√∫mero consecutivo
            patron_test = "SCHEMA-CWS-TS"
            print(f"üî¢ Probando generaci√≥n consecutiva para patr√≥n: {patron_test}")
            
            # Simular datos para generaci√≥n de n√∫mero
            datos_generales = {
                'cliente': 'SCHEMA-TEST',
                'vendedor': 'Test Schema',
                'proyecto': 'CONTADOR-TEST'
            }
            
            numero_generado = db.generar_numero_automatico(datos_generales)
            print(f"‚úÖ N√∫mero generado: {numero_generado}")
            
            # Verificar formato del n√∫mero
            partes = numero_generado.split('-')
            if len(partes) >= 5 and 'CWS' in partes:
                print("‚úÖ Formato de n√∫mero correcto")
                return True
            else:
                print(f"‚ùå Formato de n√∫mero incorrecto: {numero_generado}")
                return False
        else:
            print("‚ùå No hay contadores configurados")
            return False
            
    except Exception as e:
        print(f"‚ùå ERROR en test de contadores: {e}")
        return False

def test_estadisticas(db):
    """Test 6: Obtener estad√≠sticas del sistema"""
    print("\n" + "="*60)
    print("TEST 6: ESTAD√çSTICAS DEL SISTEMA")
    print("="*60)
    
    try:
        stats = db.obtener_estadisticas()
        
        print("üìä Estad√≠sticas obtenidas:")
        for key, value in stats.items():
            print(f"   {key}: {value}")
        
        # Verificar que las estad√≠sticas indican modo online
        if stats.get('modo') == 'online':
            print("‚úÖ Sistema funcionando en modo ONLINE")
            return True
        else:
            print(f"‚ùå Sistema en modo: {stats.get('modo', 'unknown')}")
            return False
            
    except Exception as e:
        print(f"‚ùå ERROR obteniendo estad√≠sticas: {e}")
        return False

def main():
    """Ejecutar todos los tests"""
    print("üß™ VALIDACI√ìN COMPLETA DEL ESQUEMA SUPABASE")
    print("=" * 80)
    print("Este script verifica que fix_supabase_schema.sql fue ejecutado correctamente")
    print("=" * 80)
    
    # Lista de tests a ejecutar
    tests = [
        ("Conexi√≥n a Supabase", test_conexion_supabase),
        ("Verificar tablas", None),  # Se pasa el db como par√°metro
        ("Estructura cotizaciones", None),
        ("Inserci√≥n completa", None),
        ("Contadores at√≥micos", None),
        ("Estad√≠sticas sistema", None)
    ]
    
    # Test 1: Conexi√≥n
    db = None
    if not test_conexion_supabase():
        print("\n‚ùå RESULTADO FINAL: FALLO EN CONEXI√ìN")
        print("\nSOLUCI√ìN:")
        print("1. Verificar variables de entorno (DATABASE_URL, SUPABASE_URL, SUPABASE_ANON_KEY)")
        print("2. Ejecutar fix_supabase_schema.sql en Supabase Dashboard")
        print("3. Reintentar este test")
        return False
    
    # Crear instancia para tests posteriores
    db = SupabaseManager()
    
    # Ejecutar tests restantes
    tests_passed = 1  # Conexi√≥n ya pas√≥
    tests_failed = 0
    
    test_functions = [
        test_tablas_existen,
        test_estructura_cotizaciones, 
        test_insertar_cotizacion_completa,
        test_contadores_atomicos,
        test_estadisticas
    ]
    
    for i, test_func in enumerate(test_functions):
        try:
            if test_func(db):
                tests_passed += 1
            else:
                tests_failed += 1
        except Exception as e:
            print(f"‚ùå ERROR CR√çTICO en test: {e}")
            tests_failed += 1
    
    # Resultado final
    total_tests = tests_passed + tests_failed
    print("\n" + "="*80)
    print("üéØ RESULTADO FINAL")
    print("="*80)
    
    if tests_failed == 0:
        print("üéâ ‚úÖ TODOS LOS TESTS PASARON")
        print(f"   Tests exitosos: {tests_passed}/{total_tests}")
        print("\nüìã ESTADO DEL SISTEMA:")
        print("   ‚úÖ Esquema Supabase completo y funcional")
        print("   ‚úÖ Aplicaci√≥n deber√≠a funcionar correctamente")
        print("   ‚úÖ Guardado en PostgreSQL habilitado")
        print("   ‚úÖ Supabase Storage sigue funcionando")
        print("\nüöÄ PR√ìXIMO PASO:")
        print("   La aplicaci√≥n ya deber√≠a guardar en Supabase DB en lugar de solo JSON offline")
        
        # Cerrar conexi√≥n
        if db:
            db.close()
        
        return True
    else:
        print("‚ùå ALGUNOS TESTS FALLARON")
        print(f"   Tests exitosos: {tests_passed}/{total_tests}")
        print(f"   Tests fallidos: {tests_failed}/{total_tests}")
        print("\nüîß ACCIONES REQUERIDAS:")
        print("   1. Ejecutar fix_supabase_schema.sql completo en Supabase Dashboard")
        print("   2. Verificar variables de entorno")
        print("   3. Revisar logs de errores arriba")
        print("   4. Reintentar este test")
        
        # Cerrar conexi√≥n
        if db:
            db.close()
        
        return False

if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)